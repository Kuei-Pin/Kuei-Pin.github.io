<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="xuguibin, ios" />










<meta name="description" content="AFNetworkingæ˜¯iOSå¼€å‘ä¸­æœ€å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹å¼€æºåº“ä¹‹ä¸€ï¼Œå®ƒä¸»è¦ç”¨äºè¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚AFNetworkingä¸»è¦æ˜¯å¯¹HTTPåè®®å’ŒiOSç½‘ç»œç›¸å…³åº“çš„å°è£…ï¼Œè¯»ä¸€è¯»æºç å¯ä»¥åŠ æ·±å¯¹HTTPåè®®å’ŒiOSç½‘ç»œç¼–ç¨‹çš„ç†è§£ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="è¯»ä¸€è¯»AFNetworking3">
<meta property="og:url" content="https://xxxxxxgb.github.io/2018/05/02/AFNetworking/index.html">
<meta property="og:site_name" content="è®¸æ¡‚æ–Œçš„åšå®¢">
<meta property="og:description" content="AFNetworkingæ˜¯iOSå¼€å‘ä¸­æœ€å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹å¼€æºåº“ä¹‹ä¸€ï¼Œå®ƒä¸»è¦ç”¨äºè¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚AFNetworkingä¸»è¦æ˜¯å¯¹HTTPåè®®å’ŒiOSç½‘ç»œç›¸å…³åº“çš„å°è£…ï¼Œè¯»ä¸€è¯»æºç å¯ä»¥åŠ æ·±å¯¹HTTPåè®®å’ŒiOSç½‘ç»œç¼–ç¨‹çš„ç†è§£ã€‚">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://xxxxxxgb.github.io/images/NSURLSession_structure.jpg">
<meta property="og:image" content="https://xxxxxxgb.github.io/images/NSURLSession_create_tasks.png">
<meta property="og:updated_time" content="2018-05-26T09:11:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="è¯»ä¸€è¯»AFNetworking3">
<meta name="twitter:description" content="AFNetworkingæ˜¯iOSå¼€å‘ä¸­æœ€å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹å¼€æºåº“ä¹‹ä¸€ï¼Œå®ƒä¸»è¦ç”¨äºè¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚AFNetworkingä¸»è¦æ˜¯å¯¹HTTPåè®®å’ŒiOSç½‘ç»œç›¸å…³åº“çš„å°è£…ï¼Œè¯»ä¸€è¯»æºç å¯ä»¥åŠ æ·±å¯¹HTTPåè®®å’ŒiOSç½‘ç»œç¼–ç¨‹çš„ç†è§£ã€‚">
<meta name="twitter:image" content="https://xxxxxxgb.github.io/images/NSURLSession_structure.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://xxxxxxgb.github.io/2018/05/02/AFNetworking/"/>





  <title>è¯»ä¸€è¯»AFNetworking3 | è®¸æ¡‚æ–Œçš„åšå®¢</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b728f881bd233f20a31842facda5c201";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">è®¸æ¡‚æ–Œçš„åšå®¢</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

<script>
    (function(){
        if(''){
            if (prompt('è¯·è¾“å…¥æ–‡ç« å¯†ç ') !== ''){
                alert('å¯†ç é”™è¯¯ï¼');
                history.back();
            }
        }
    })();
</script>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xxxxxxgb.github.io/2018/05/02/AFNetworking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="è®¸æ¡‚æ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è®¸æ¡‚æ–Œçš„åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">è¯»ä¸€è¯»AFNetworking3</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-05-01T20:28:45Z">
                2018-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/æºç /" itemprop="url" rel="index">
                    <span itemprop="name">æºç </span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/02/AFNetworking/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2018/05/02/AFNetworking/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  8,953
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><code>AFNetworking</code>æ˜¯iOSå¼€å‘ä¸­æœ€å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹å¼€æºåº“ä¹‹ä¸€ï¼Œå®ƒä¸»è¦ç”¨äºè¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚<code>AFNetworking</code>ä¸»è¦æ˜¯å¯¹HTTPåè®®å’ŒiOSç½‘ç»œç›¸å…³åº“çš„å°è£…ï¼Œè¯»ä¸€è¯»æºç å¯ä»¥åŠ æ·±å¯¹HTTPåè®®å’ŒiOSç½‘ç»œç¼–ç¨‹çš„ç†è§£ã€‚</p>
<a id="more"></a>
<h1 id="AFNetworkingçš„ç»“æ„"><a href="#AFNetworkingçš„ç»“æ„" class="headerlink" title="AFNetworkingçš„ç»“æ„"></a>AFNetworkingçš„ç»“æ„</h1><p><code>AFNetworking</code>ä¸»è¦åˆ†ä¸ºå››ä¸ªæ¨¡å—ï¼š</p>
<ul>
<li>å¤„ç†è¯·æ±‚å’Œå›å¤çš„åºåˆ—åŒ–æ¨¡å—ï¼šSerialization</li>
<li>ç½‘ç»œå®‰å…¨æ¨¡å—ï¼šSecurity</li>
<li>ç½‘ç»œç›‘æµ‹æ¨¡å—ï¼šReachability</li>
<li>å¤„ç†é€šè®¯çš„ä¼šè¯æ¨¡å—ï¼šNSURLSession<br>å…¶ä¸­NSURLSessionæ˜¯æœ€å¸¸ä½¿ç”¨çš„æ¨¡å—ï¼Œä¹Ÿæ˜¯ç»¼åˆæ¨¡å—ï¼Œå®ƒå¼•ç”¨äº†å…¶ä»–çš„å‡ ä¸ªæ¨¡å—ï¼Œè€Œå…¶ä»–å‡ ä¸ªæ¨¡å—éƒ½æ˜¯ç‹¬ç«‹çš„æ¨¡å—ï¼Œæ‰€ä»¥å¯¹<code>AFNetworking</code>çš„å­¦ä¹ å°±å…ˆä»è¿™äº›å•ç‹¬çš„æ¨¡å—å¼€å§‹ã€‚</li>
</ul>
<h1 id="Serializationæ¨¡å—"><a href="#Serializationæ¨¡å—" class="headerlink" title="Serializationæ¨¡å—"></a>Serializationæ¨¡å—</h1><p>Serializationæ¨¡å—åŒ…æ‹¬è¯·æ±‚åºåˆ—åŒ–<code>AFURLRequestSerialization</code>å’Œå“åº”åºåˆ—åŒ–<code>AFURLResponseSerialization</code>ï¼Œå®ƒä»¬ä¸»è¦åŠŸèƒ½ï¼š</p>
<ul>
<li><code>AFURLRequestSerialization</code>ç”¨æ¥å°†å­—å…¸å‚æ•°ç¼–ç æˆURLä¼ è¾“å‚æ•°ï¼Œå¹¶æä¾›ä¸Šä¼ æ–‡ä»¶çš„åŸºæœ¬åŠŸèƒ½å®ç°ã€‚</li>
<li><code>AFURLResponseSerialization</code>ç”¨æ¥å¤„ç†æœåŠ¡å™¨è¿”å›æ•°æ®ï¼Œæä¾›è¿”å›ç æ ¡éªŒå’Œæ•°æ®æ ¡éªŒçš„åŠŸèƒ½ã€‚</li>
</ul>
<p>Serializationåˆ†ä¸ºå››ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«æ¥çœ‹è¿™å››ä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚</p>
<h2 id="AFURLRequestSerialization-h"><a href="#AFURLRequestSerialization-h" class="headerlink" title="AFURLRequestSerialization.h"></a>AFURLRequestSerialization.h</h2><p>å…ˆå£°æ˜äº†ä¸€ä¸ªåè®®<code>AFURLRequestSerialization</code>ç»§æ‰¿äº†<code>NSSecureCoding</code>å’Œ<code>NSCopying</code>æ¥ä¿è¯æ‰€æœ‰å®ç°è¿™ä¸ªåºåˆ—åŒ–åè®®çš„åºåˆ—åŒ–å™¨ç±»éƒ½æœ‰<a href="http://nshipster.cn/nssecurecoding/" target="_blank" rel="noopener">å®‰å…¨ç¼–ç </a>å’Œ<a href="https://developer.apple.com/documentation/foundation/nscopying" target="_blank" rel="noopener">å¤åˆ¶</a>çš„èƒ½åŠ›ã€‚åè®®ä¹Ÿå®šä¹‰äº†åºåˆ—åŒ–çš„è§„èŒƒæ–¹æ³•ã€‚ï¼ˆè™½ç„¶ç›®å‰åªæœ‰ä¸€ä¸ªç±»å®ç°äº†åè®®ï¼Œæ„Ÿè§‰æ²¡å•¥å¿…è¦..ä½†è¿™æ˜¯ä¸€ç§è§„èŒƒï¼Œæœ‰åˆ©äºæ‰©å±•ã€‚ï¼‰</p>
<figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    AFURLRequestSerializationåè®®å¯ä»¥è¢«ä¸€ä¸ªç¼–ç ç‰¹å®šhttpè¯·æ±‚çš„å¯¹è±¡å®ç°ã€‚</span></div><div class="line"><span class="comment">    è¯·æ±‚åºåˆ—åŒ–å™¨ï¼ˆRequest serializerï¼‰å¯ä»¥ç¼–ç æŸ¥è¯¢è¯­å¥ã€HTTPè¯·æ±‚ä½“ï¼Œå¦‚æœå¿…é¡»çš„è¯ï¼Œå¯ä»¥è‡ªè¡Œè®¾ç½®åˆé€‚çš„HTTPè¯·æ±‚ä½“å†…å®¹ï¼ˆå¦‚ï¼šAgent:iOSï¼‰ã€‚</span></div><div class="line"><span class="comment">    ä¾‹å¦‚ï¼Œä¸€ä¸ªJSONè¯·æ±‚åºåˆ—åŒ–å™¨ä¼šæŠŠè¯·æ±‚ä½“Content-Typeè®¾ç½®ä¸ºapplication/jsonã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">AFURLRequestSerialization</span> &lt;<span class="title">NSObject</span>, <span class="title">NSSecureCoding</span>, <span class="title">NSCopying</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    è¿”å›ä¸€ä¸ªä½¿ç”¨äº†æŒ‡å®šå‚æ•°ç¼–ç çš„è¯·æ±‚çš„æ‹·è´ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</div><div class="line">                               withParameters:(<span class="keyword">nullable</span> <span class="keyword">id</span>)parameters</div><div class="line">                                        error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error <span class="built_in">NS_SWIFT_NOTHROW</span>;</div><div class="line"><span class="keyword">@end</span></div></pre></div></div></figure>
<h3 id="å…¬å¼€å±æ€§"><a href="#å…¬å¼€å±æ€§" class="headerlink" title="å…¬å¼€å±æ€§"></a>å…¬å¼€å±æ€§</h3><p>HTTPåºåˆ—åŒ–å™¨ç±»<code>AFHTTPRequestSerializer</code>,å®ç°äº†<code>AFURLRequestSerialization</code>åè®®ï¼Œå¹¶å‚è€ƒäº†<code>NSMutableURLRequest</code>ç±»å£°æ˜äº†å¾ˆå¤šè¯·æ±‚è®¾ç½®ç›¸å…³å±æ€§ã€‚</p>
<p><strong>AFHTTPRequestSerializerå’Œå…¶ä¸»è¦å…¬å¼€å±æ€§</strong><br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    AFHTTPRequestSerializerå®ç°äº†AFURLRequestSerializationåè®®ï¼Œä¸ºæŸ¥è¯¢è¯­å¥ã€URLè¡¨å•ç¼–ç å‚æ•°çš„åºåˆ—åŒ–æä¾›ä¸€ä¸ªå…·ä½“çš„å®ç°å’Œé»˜è®¤çš„è¯·æ±‚å¤´ï¼Œä»¥åŠçŠ¶æ€ç å’Œå†…å®¹ç±»å‹çš„æ ¡éªŒã€‚</span></div><div class="line"><span class="comment">    æ‰€æœ‰çš„requestå’Œresponseéƒ½è¢«é¼“åŠ±å»ç»§æ‰¿AFHTTPRequestSerializerç±»ï¼Œä»¥ç¡®ä¿é»˜è®¤æ–¹æ³•å’Œå±æ€§çš„ä¸€è‡´æ€§ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFHTTPRequestSerializer</span> : <span class="title">NSObject</span> &lt;<span class="title">AFURLRequestSerialization</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    å­—ç¬¦ä¸²ç¼–ç æ–¹å¼ï¼Œé»˜è®¤ä¸ºNSUTF8StringEncoding</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    ç¼“å­˜ç­–ç•¥ã€‚é»˜è®¤ä¸ºNSURLRequestUseProtocolCachePolicy</span></div><div class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setCachePolicy:</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSURLRequestCachePolicy</span> cachePolicy;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    æ˜¯å¦ç”¨cookieæ¥å¤„ç†åˆ›å»ºçš„è¯·æ±‚ã€‚é»˜è®¤ä¸ºYES</span></div><div class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setHTTPShouldHandleCookies</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> HTTPShouldHandleCookies;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    åˆ›å»ºçš„è¯·æ±‚åœ¨æ”¶åˆ°ä¸Šä¸ªä¼ è¾“ï¼ˆtransmissionï¼‰å“åº”ä¹‹å‰æ˜¯å¦ç»§ç»­å‘é€æ•°æ®ã€‚</span></div><div class="line"><span class="comment">    é»˜è®¤ä¸ºNO(å³ç­‰å¾…ä¸Šæ¬¡ä¼ è¾“å®Œæˆåå†è¯·æ±‚)</span></div><div class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setHTTPShouldUsePipelining:</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> HTTPShouldUsePipelining;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    è¯·æ±‚çš„ç½‘ç»œæœåŠ¡ç±»å‹ã€‚</span></div><div class="line"><span class="comment">    è¿™ä¸ªæœåŠ¡ç±»å‹å‘æ•´ä¸ªç½‘ç»œä¼ è¾“å±‚æ¬¡æä¾›äº†ä¸€ä¸ªå…³äºè¯¥è¯·æ±‚ç›®çš„çš„æç¤ºã€‚</span></div><div class="line"><span class="comment">    ï¼ˆThe service type is used to provide the networking layers a hint of the purpose of the request.ï¼‰</span></div><div class="line"><span class="comment">    é»˜è®¤ä¸ºNSURLNetworkServiceTypeDefault</span></div><div class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setNetworkServiceType:</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSURLRequestNetworkServiceType</span> networkServiceType;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    è¯·æ±‚çš„è¶…æ—¶é—´éš”ï¼Œå•ä½ç§’ã€‚é»˜è®¤ä¸º60ç§’</span></div><div class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setTimeoutInterval:</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> timeoutInterval;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    åºåˆ—è¯·æ±‚çš„é»˜è®¤è¯·æ±‚å¤´ã€‚é»˜è®¤å€¼åŒ…æ‹¬</span></div><div class="line"><span class="comment">    'Accept-Languageâ€™  å†…å®¹ä¸º 'NSLocale +preferredLanguagesâ€™ æ–¹æ³•è·å–çš„è¯­éŸ³</span></div><div class="line"><span class="comment">    'User-Agentâ€™  å†…å®¹ä¸ºå„ç§bundleçš„æ ‡å¿—å·²ç»ç³»ç»Ÿä¿¡æ¯</span></div><div class="line"><span class="comment">    å¯ä»¥ä½¿ç”¨'setValue:forHTTPHeaderField:â€™æ–¹æ³•æ·»åŠ æˆ–åˆ é™¤è¯·æ±‚å¤´</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSString</span> *&gt; *HTTPRequestHeaders;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">	å“ªäº›HTTPè¯·æ±‚æ–¹æ³•ä¼šå°†å‚æ•°ç¼–ç æˆæŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆå¦‚:name=xgb&amp;gender=1ï¼‰ã€‚é»˜è®¤ä¸ºGET, HEADå’ŒDELETEã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSSet</span> &lt;<span class="built_in">NSString</span> *&gt; *HTTPMethodsEncodingParametersInURI;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    éœ€è¦å°†å‚æ•°è½¬æ¢æˆæŸ¥è¯¢è¯­å¥çš„HTTPè¯·æ±‚æ–¹å¼ã€‚é»˜è®¤åŒ…æ‹¬GETã€HEADå’ŒDELETEã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSSet</span> &lt;<span class="built_in">NSString</span> *&gt; *HTTPMethodsEncodingParametersInURI;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></div></div></figure></p>
<p><strong>å±æ€§çš„ç†è§£ï¼š</strong><br><code>stringEncoding</code>ä¸€èˆ¬æœåŠ¡å™¨éƒ½æ˜¯utf-8æ ¼å¼ï¼Œæ²¡å¿…è¦ç”¨åˆ°<a href="https://developer.apple.com/documentation/foundation/foundation_enumerations/1497293-anonymous" target="_blank" rel="noopener">å…¶ä»–</a>ã€‚<br><code>cachePolicy</code>ç¼“å­˜ç­–ç•¥ï¼Œ<a href="https://developer.apple.com/documentation/foundation/nsurlrequestcachepolicy?language=objc" target="_blank" rel="noopener">è‹¹æœ</a>ä¸»è¦å®šä¹‰äº†å››ç§å¯ä¾›é€‰æ‹©çš„ç¼“å­˜ç­–ç•¥ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    NSURLRequestUseProtocolCachePolicyæ˜¯é»˜è®¤çš„ç¼“å­˜ç­–ç•¥ï¼Œå®ƒä½¿ç”¨å½“å‰URLçš„åè®®ä¸­é¢„ç½®çš„ç¼“å­˜ç­–ç•¥ï¼Œæ— è®ºè¿™ä¸ªåè®®æ˜¯httpï¼Œè¿˜æ˜¯è¯´ä½ è‡ªå·±å®šä¹‰åè®®ã€‚</span></div><div class="line"><span class="comment">    å¯¹äºå¸¸è§çš„httpåè®®æ¥è¯´ï¼Œè¿™ä¸ªç­–ç•¥æ ¹æ®è¯·æ±‚çš„å¤´æ¥æ‰§è¡Œç¼“å­˜ç­–ç•¥ã€‚æœåŠ¡å™¨å¯ä»¥åœ¨è¿”å›çš„å“åº”å¤´ä¸­åŠ å…¥Expiresç­–ç•¥æˆ–è€…Cache-Controlç­–ç•¥æ¥å‘Šè¯‰å®¢æˆ·ç«¯åº”è¯¥æ‰§è¡Œçš„ç¼“å­˜è¡Œä¸ºï¼ŒåŒæ—¶é…åˆLast-Modifiedç­‰å¤´æ¥æ§åˆ¶åˆ·æ–°çš„æ—¶æœºã€‚</span></div><div class="line"><span class="comment">    å…³äºè¯¦ç»†çš„webç¼“å­˜å¤„ç†https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=zh-cn</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="built_in">NSURLRequestUseProtocolCachePolicy</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    ä¸ä½¿ç”¨ç¼“å­˜ï¼Œç›¸å½“äºè¯·æ±‚å¤´çš„no-storeï¼Œåœ¨è¿›è¡ŒåŒ…å«ä¸ªäººéšç§æ•°æ®æˆ–é“¶è¡Œä¸šåŠ¡æ•°æ®ç­‰æ•æ„Ÿä¿¡æ¯çš„è¯·æ±‚æ—¶å¯ä»¥ä½¿ç”¨ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="built_in">NSURLRequestReloadIgnoringCacheData</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    NSURLRequestReturnCacheDataElseLoad è¿™ä¸ªç­–ç•¥æ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒä¼šä¸€ç›´å¿è¯•è¯»å–ç¼“å­˜æ•°æ®ï¼Œç›´åˆ°æ— æ³•æ²¡æœ‰ç¼“å­˜æ•°æ®çš„æ—¶å€™ï¼Œæ‰ä¼šå»è¯·æ±‚ç½‘ç»œã€‚</span></div><div class="line"><span class="comment">    è¿™ä¸ªç­–ç•¥æœ‰ä¸€ä¸ªé‡å¤§çš„ç¼ºé™·å¯¼è‡´å®ƒæ ¹æœ¬æ— æ³•è¢«ä½¿ç”¨ï¼Œå³å®ƒæ ¹æœ¬æ²¡æœ‰å¯¹ç¼“å­˜çš„åˆ·æ–°æ—¶æœºè¿›è¡Œæ§åˆ¶ï¼Œå¦‚æœä½ è¦å»ä½¿ç”¨å®ƒï¼Œé‚£ä¹ˆéœ€è¦é¢å¤–çš„è¿›è¡Œå¯¹ç¼“å­˜è¿‡æœŸè¿›è¡Œæ§åˆ¶ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="built_in">NSURLRequestReturnCacheDataElseLoad</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    åªè¯»ç¼“å­˜å¹¶ä¸”å³æ—¶ç¼“å­˜ä¸å­˜åœ¨éƒ½ä¸å»è¯·æ±‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="built_in">NSURLRequestReturnCacheDataDontLoad</span></div></pre></div></div></figure></p>
<p><code>HTTPShouldHandleCookies</code>ã€<code>HTTPShouldUsePipelining</code>è¿™ä¸¤ä¸ªå±æ€§ä¸€èˆ¬ä¸éœ€è¦ä¿®æ”¹ï¼Œä½¿ç”¨é»˜è®¤å³å¯ã€‚<br><code>networkServiceType</code>ç”¨äºè®¾ç½®è¿™ä¸ªè¯·æ±‚çš„ç³»ç»Ÿå¤„ç†ä¼˜å…ˆçº§ï¼Œè¿™ä¸ªå±æ€§ä¼šå½±å“ç³»ç»Ÿå¯¹ç½‘ç»œè¯·æ±‚çš„å”¤é†’é€Ÿåº¦ï¼Œä¾‹å¦‚FaceTimeä½¿ç”¨äº†VoIPåè®®å°±éœ€è¦è®¾ç½®ä¸ºNSURLNetworkServiceTypeVoIPæ¥ä½¿å¾—åœ¨åå°æ¥æ”¶åˆ°æ•°æ®æ—¶ä¹Ÿèƒ½å¿«é€Ÿå”¤é†’åº”ç”¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦ç”¨åˆ°ã€‚<br><code>timeoutInterval</code>è¯·æ±‚è¶…æ—¶æ—¶é—´ã€‚<br><code>HTTPRequestHeaders</code>å…¶ä»–è¯·æ±‚å¤´è®¾ç½®ã€‚</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p><code>AFHTTPRequestSerializer</code>çš„APIåˆ†ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ™®é€šçš„å‚æ•°è¯·æ±‚ï¼Œå¦ä¸€ç§æ˜¯éœ€è¦ä¸Šä¼ æ–‡ä»¶çš„è¯·æ±‚ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/** é€šè¿‡URLå­—ç¬¦ä¸²å’Œå­—å…¸å‚æ•°æ¥æ„å»ºè¯·æ±‚ */</span></div><div class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestWithMethod:(<span class="built_in">NSString</span> *)method</div><div class="line">                                 URLString:(<span class="built_in">NSString</span> *)URLString</div><div class="line">                                parameters:(<span class="keyword">nullable</span> <span class="keyword">id</span>)parameters</div><div class="line">                                     error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</div><div class="line"></div><div class="line"><span class="comment">/** ä¸Šä¼ æ–‡ä»¶çš„APIï¼Œéœ€è¦é€šè¿‡å®ç°äº†AFMultipartFormDataåè®®çš„formDataå¯¹è±¡å¤„ç†å¾…ä¸Šä¼ æ–‡ä»¶ */</span>                     </div><div class="line">- (<span class="built_in">NSMutableURLRequest</span> *)multipartFormRequestWithMethod:(<span class="built_in">NSString</span> *)method</div><div class="line">                                              URLString:(<span class="built_in">NSString</span> *)URLString</div><div class="line">                                             parameters:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)parameters</div><div class="line">                              constructingBodyWithBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="keyword">id</span> &lt;AFMultipartFormData&gt; formData))block</div><div class="line">                                                  error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</div></pre></div></div></figure></p>
<h3 id="AFMultipartFormDataåè®®"><a href="#AFMultipartFormDataåè®®" class="headerlink" title="AFMultipartFormDataåè®®"></a>AFMultipartFormDataåè®®</h3><p><code>AFHTTPRequestSerializer</code>å®ç°äº†å¯¹ä¸Šä¼ æ–‡ä»¶çš„æ”¯æŒï¼Œ<code>AFMultipartFormData</code>åè®®å°±æ˜¯å®šä¹‰æ·»åŠ éœ€ä¸Šä¼ æ–‡ä»¶çš„æ–¹æ³•ï¼Œæœ‰ç±»ä¼¼ä»¥ä¸‹çš„æ–¹æ³•ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/** é€šè¿‡URLå®šä½å¾…ä¸Šä¼ æ–‡ä»¶ */</span></div><div class="line">- (<span class="built_in">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL</div><div class="line">                         name:(<span class="built_in">NSString</span> *)name</div><div class="line">                        error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</div><div class="line">                        </div><div class="line"><span class="comment">/** é€šè¿‡NSInputStreamå®šä¹‰å¾…ä¸Šä¼ æ–‡ä»¶ */</span></div><div class="line"> - (<span class="keyword">void</span>)appendPartWithInputStream:(<span class="keyword">nullable</span> <span class="built_in">NSInputStream</span> *)inputStream</div><div class="line">                             name:(<span class="built_in">NSString</span> *)name</div><div class="line">                         fileName:(<span class="built_in">NSString</span> *)fileName</div><div class="line">                           length:(int64_t)length</div><div class="line">                         mimeType:(<span class="built_in">NSString</span> *)mimeType;</div><div class="line">                         </div><div class="line"><span class="comment">/** é€šè¿‡NSDataæ•°æ®ä¸Šä¼  */</span></div><div class="line">- (<span class="keyword">void</span>)appendPartWithFileData:(<span class="built_in">NSData</span> *)data</div><div class="line">                          name:(<span class="built_in">NSString</span> *)name</div><div class="line">                      fileName:(<span class="built_in">NSString</span> *)fileName</div><div class="line">                      mimeType:(<span class="built_in">NSString</span> *)mimeType;</div></pre></div></div></figure></p>
<h2 id="AFURLRequestSerialization-m"><a href="#AFURLRequestSerialization-m" class="headerlink" title="AFURLRequestSerialization.m"></a>AFURLRequestSerialization.m</h2><h3 id="å·¥å…·æ–¹æ³•"><a href="#å·¥å…·æ–¹æ³•" class="headerlink" title="å·¥å…·æ–¹æ³•"></a>å·¥å…·æ–¹æ³•</h3><p>åœ¨äº†è§£<code>AFURLRequestSerialization</code>æ€ä¹ˆå®ç°ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸‹<code>AFURLRequestSerialization.m</code>å®šä¹‰çš„ä¸€äº›å·¥å…·æ–¹æ³•ï¼š</p>
<ul>
<li><code>AFPercentEscapedStringFromString</code>æ–¹æ³•ç”¨äºå°†å­—ç¬¦ä¸²è½¬åŒ–æˆç¬¦åˆæ ‡å‡†çš„<a href="https://zh.wikipedia.org/wiki/%E7%99%BE%E5%88%86%E5%8F%B7%E7%BC%96%E7%A0%81" target="_blank" rel="noopener">URLç¼–ç å­—ç¬¦ä¸²</a>ï¼Œä»£ç å¦‚ä¸‹ï¼š<figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></div><div class="code"><pre><div class="line"><span class="built_in">NSString</span> * AFPercentEscapedStringFromString(<span class="built_in">NSString</span> *string) &#123;</div><div class="line">    <span class="comment">// does not include "?" or "/" due to RFC 3986 - Section 3.4</span></div><div class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kAFCharactersGeneralDelimitersToEncode = <span class="string">@":#[]@"</span>;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kAFCharactersSubDelimitersToEncode = <span class="string">@"!$&amp;'()*+,;="</span>;</div><div class="line"></div><div class="line">    <span class="built_in">NSMutableCharacterSet</span> * allowedCharacterSet = [[<span class="built_in">NSCharacterSet</span> URLQueryAllowedCharacterSet] mutableCopy];</div><div class="line">    [allowedCharacterSet removeCharactersInString:[kAFCharactersGeneralDelimitersToEncode stringByAppendingString:kAFCharactersSubDelimitersToEncode]];</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="built_in">NSUInteger</span> <span class="keyword">const</span> batchSize = <span class="number">50</span>;</div><div class="line"></div><div class="line">    <span class="built_in">NSUInteger</span> index = <span class="number">0</span>;</div><div class="line">    <span class="built_in">NSMutableString</span> *escaped = <span class="string">@""</span>.mutableCopy;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (index &lt; string.length) &#123;</div><div class="line">        <span class="built_in">NSUInteger</span> length = MIN(string.length - index, batchSize);</div><div class="line">        <span class="built_in">NSRange</span> range = <span class="built_in">NSMakeRange</span>(index, length);</div><div class="line"></div><div class="line">        <span class="comment">// To avoid breaking up character sequences such as ğŸ‘´ğŸ»ğŸ‘®ğŸ½</span></div><div class="line">        range = [string rangeOfComposedCharacterSequencesForRange:range];</div><div class="line"></div><div class="line">        <span class="built_in">NSString</span> *substring = [string substringWithRange:range];</div><div class="line">        <span class="built_in">NSString</span> *encoded = [substring stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</div><div class="line">        [escaped appendString:encoded];</div><div class="line"></div><div class="line">        index += range.length;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> escaped;</div><div class="line">&#125;</div></pre></div></div></figure>
</li>
</ul>
<p>ä¸Šé¢ä»£ç çš„å®ç°ä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªå­—ç¬¦é›†<code>NSMutableCharacterSet</code>æ¥å®šä¹‰éœ€è¦è¿›è¡Œè½¬ç çš„å­—ç¬¦ï¼Œå†é€šè¿‡-[NSString stringByAddingPercentEncodingWithAllowedCharacters]æ–¹æ³•æ¥è¿›è¡Œè½¬ç ã€‚</p>
<ul>
<li><code>AFQueryStringFromParameters</code>æ–¹æ³•ç”¨äºå°†å­—å…¸è½¬æ¢æˆURLæŸ¥è¯¢å­—ç¬¦ä¸²ã€‚è½¬æ¢æ ¼å¼å¦‚ä¸‹ï¼š<figure class="highlight plain"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></div><div class="code"><pre><div class="line">å­—å…¸ &#123;name:xgb, from:gd, machine:[iphone, mac], pet:&#123;a:cat, b:dog&#125;&#125;</div><div class="line">è½¬æ¢ä¸º name=xgb&amp;from=gd&amp;machine[]=iphone&amp;machine[]=mac&amp;pet[a]=cat&amp;pet[b]=dog</div></pre></div></div></figure>
</li>
</ul>
<p>AFNetworkingå®šä¹‰äº†ä¸€ä¸ªModelç±»<code>AFQueryStringPair</code>æ¥å­˜å–æ¯ä¸€ä¸ªæŸ¥è¯¢å±æ€§ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></div><div class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFQueryStringPair</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> field;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> value;</div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)initWithField:(<span class="keyword">id</span>)field value:(<span class="keyword">id</span>)value;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)URLEncodedStringValue;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFQueryStringPair</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)initWithField:(<span class="keyword">id</span>)field value:(<span class="keyword">id</span>)value &#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.field = field;</div><div class="line">    <span class="keyword">self</span>.value = value;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)URLEncodedStringValue &#123;</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.value || [<span class="keyword">self</span>.value isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</div><div class="line">        <span class="keyword">return</span> AFPercentEscapedStringFromString([<span class="keyword">self</span>.field description]);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@=%@"</span>, AFPercentEscapedStringFromString([<span class="keyword">self</span>.field description]), AFPercentEscapedStringFromString([<span class="keyword">self</span>.value description])];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></div></div></figure></p>
<p>å°†æŸ¥è¯¢çš„é”®å€¼ä¿æŒèµ·æ¥ï¼Œç„¶åé€šè¿‡<code>URLEncodedStringValue</code>æ–¹æ³•åœ¨éœ€è¦æ—¶è¿›è¡Œæ‹¼æ¥ï¼Œå¹¶ä¸”ä½¿ç”¨äº†ä¸Šé¢æ‰€è¿°çš„<code>AFPercentEscapedStringFromString</code>æ–¹æ³•è¿›è¡Œäº†URLEncodeã€‚æ¥ä¸‹æ¥å†çœ‹çœ‹<code>AFQueryStringFromParameters</code>æ–¹æ³•çš„ä¸»è¦å®ç°ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></div><div class="code"><pre><div class="line"><span class="built_in">NSString</span> * AFQueryStringFromParameters(<span class="built_in">NSDictionary</span> *parameters) &#123;</div><div class="line">    <span class="built_in">NSMutableArray</span> *mutablePairs = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">    <span class="keyword">for</span> (AFQueryStringPair *pair <span class="keyword">in</span> AFQueryStringPairsFromDictionary(parameters)) &#123;</div><div class="line">        [mutablePairs addObject:[pair URLEncodedStringValue]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [mutablePairs componentsJoinedByString:<span class="string">@"&amp;"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">NSArray</span> * AFQueryStringPairsFromDictionary(<span class="built_in">NSDictionary</span> *dictionary) &#123;</div><div class="line">    <span class="keyword">return</span> AFQueryStringPairsFromKeyAndValue(<span class="literal">nil</span>, dictionary);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">NSArray</span> * AFQueryStringPairsFromKeyAndValue(<span class="built_in">NSString</span> *key, <span class="keyword">id</span> value) &#123;</div><div class="line">    <span class="built_in">NSMutableArray</span> *mutableQueryStringComponents = [<span class="built_in">NSMutableArray</span> array];</div><div class="line"></div><div class="line">    <span class="built_in">NSSortDescriptor</span> *sortDescriptor = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"description"</span> ascending:<span class="literal">YES</span> selector:<span class="keyword">@selector</span>(compare:)];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</div><div class="line">        <span class="built_in">NSDictionary</span> *dictionary = value;</div><div class="line">        <span class="comment">// Sort dictionary keys to ensure consistent ordering in query string, which is important when deserializing potentially ambiguous sequences, such as an array of dictionaries</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> nestedKey <span class="keyword">in</span> [dictionary.allKeys sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</div><div class="line">            <span class="keyword">id</span> nestedValue = dictionary[nestedKey];</div><div class="line">            <span class="keyword">if</span> (nestedValue) &#123;</div><div class="line">                [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue((key ? [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@[%@]"</span>, key, nestedKey] : nestedKey), nestedValue)];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</div><div class="line">        <span class="built_in">NSArray</span> *array = value;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> nestedValue <span class="keyword">in</span> array) &#123;</div><div class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue([<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@[]"</span>, key], nestedValue)];</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) &#123;</div><div class="line">        <span class="built_in">NSSet</span> *set = value;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> [set sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</div><div class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue(key, obj)];</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        [mutableQueryStringComponents addObject:[[AFQueryStringPair alloc] initWithField:key value:value]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> mutableQueryStringComponents;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>å…¶ä¸­æœ€ä¸»è¦çš„æ–¹æ³•æ˜¯<code>AFQueryStringPairsFromKeyAndValue</code>ï¼Œå®ƒå°†å­—å…¸çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹ç”Ÿæˆçš„å¯¹åº”çš„<code>AFQueryStringPair</code>å¯¹è±¡ï¼Œä¾‹å¦‚å°†machine:[iphone, mac]è½¬æ¢ä¸º<code>URLEncodedStringValue</code>å€¼æ˜¯machine[]=iphoneå’Œmachine[]=macçš„ä¸¤ä¸ª<code>AFQueryStringPair</code>å¯¹è±¡ã€‚ä¹‹å<code>AFQueryStringFromParameters</code>æ–¹æ³•å†ä»¥â€™&amp;â€™ç¬¦å·å¯¹å®ƒä»¬è¿›è¡Œæ‹¼æ¥ã€‚</p>
<ul>
<li><code>AFHTTPRequestSerializerObservedKeyPaths</code>æ–¹æ³•å®šä¹‰å¯ä»¥éœ€è¦è¢«è§‚å¯Ÿçš„å±æ€§ï¼ˆè¿™äº›å±æ€§ä¸ºå…¬å¼€çš„å±æ€§ï¼Œå¯èƒ½è¢«ç”¨æˆ·ä¿®æ”¹ï¼‰ï¼ŒåŒ…æ‹¬<code>cachePolicy</code>ã€<code>HTTPShouldHandleCookies</code>ã€<code>HTTPShouldUsePipelining</code>ã€<code>networkServiceType</code>å’Œ<code>timeoutInterval</code>ã€‚ä»£ç å¦‚ä¸‹ï¼š<figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></div><div class="code"><pre><div class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * AFHTTPRequestSerializerObservedKeyPaths() &#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">NSArray</span> *_AFHTTPRequestSerializerObservedKeyPaths = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        _AFHTTPRequestSerializerObservedKeyPaths = @[<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowsCellularAccess)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldHandleCookies)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldUsePipelining)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(networkServiceType)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(timeoutInterval))];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> _AFHTTPRequestSerializerObservedKeyPaths;</div><div class="line">&#125;</div></pre></div></div></figure>
</li>
</ul>
<h3 id="AFHTTPRequestSerializeråºåˆ—åŒ–æµç¨‹"><a href="#AFHTTPRequestSerializeråºåˆ—åŒ–æµç¨‹" class="headerlink" title="AFHTTPRequestSerializeråºåˆ—åŒ–æµç¨‹"></a>AFHTTPRequestSerializeråºåˆ—åŒ–æµç¨‹</h3><p>æ¥ä¸‹æ¥çœ‹ä¸‹<code>AFHTTPRequestSerializer</code>çš„å®ç°ã€‚<code>AFHTTPRequestSerializer</code>åœ¨å†…éƒ¨æ‰©å±•å®šä¹‰äº†ä¸€äº›ç§æœ‰å±æ€§ï¼Œå¦‚ä¸‹ï¼š<br><strong>ä¸»è¦çš„ç§æœ‰å±æ€§</strong><br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></div><div class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFHTTPRequestSerializer</span> ()</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    ä¿å­˜ç”¨æˆ·ä¿®æ”¹è¿‡çš„å±æ€§ï¼ŒåŒ…æ‹¬AFHTTPRequestSerializerObservedKeyPathsåŒ…å«çš„å±æ€§ã€‚</span></div><div class="line"><span class="comment">    å½“ç”¨æˆ·ä¿®æ”¹è¿™äº›å±æ€§å€¼æ—¶è®°å½•èµ·æ¥ï¼Œåˆ›å»ºRequestæ—¶ä½¿ç”¨ï¼Œæ²¡ä¿®æ”¹çš„ä½¿ç”¨é»˜è®¤å€¼ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span> *mutableObservedChangedKeyPaths;</div><div class="line"><span class="comment">/** çœŸæ­£å­˜å‚¨Headerçš„å±æ€§ã€‚ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span> *mutableHTTPRequestHeaders;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    ç”¨ä¸€ä¸ªä¸²è¡Œçº¿ç¨‹æ¥ç»Ÿä¸€å¤„ç†Headerçš„ä¿®æ”¹ï¼Œé¿å…å¤šçº¿ç¨‹é€ æˆçš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">dispatch_queue_t</span> requestHeaderModificationQueue;</div><div class="line"><span class="comment">/** ç›®å‰è¿˜æ²¡å•¥ç”¨çš„å±æ€§ã€‚ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) AFHTTPRequestQueryStringSerializationStyle queryStringSerializationStyle;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    ç”¨äºè‡ªå®šä¹‰æŸ¥è¯¢å­—ç¬¦ä¸²çš„æ‹¼æ¥ã€‚</span></div><div class="line"><span class="comment">    å› ä¸ºAFURLRequestSerializationåè®®å®šä¹‰çš„æ–¹æ³•-requestBySerializingRequest:withParameters:error:ä¼ å…¥çš„parametersæ˜¯ä»¥å­—å…¸çš„å½¢å¼ä¼ å…¥ï¼Œæ‰€ä»¥éœ€è¦å°†å­—å…¸æ‹¼æ¥æˆæŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨AFQueryStringFromParametersæ–¹æ³•æ‹¼æ¥ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFQueryStringSerializationBlock queryStringSerialization;</div><div class="line"><span class="keyword">@end</span></div></pre></div></div></figure></p>
<p>é€šè¿‡å¯¹<code>AFHTTPRequestSerializer</code>å±æ€§äº†è§£ï¼Œæˆ‘ä»¬å°±èƒ½åˆæ­¥ç†è§£<code>AFHTTPRequestSerializer</code>çš„æµç¨‹ã€‚å…ˆçœ‹ä¸‹åˆå§‹åŒ–æ–¹æ³•ï¼š<br><strong>åˆå§‹åŒ–æ–¹æ³•</strong><br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></div><div class="code"><pre><div class="line">- (<span class="keyword">instancetype</span>)init &#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.stringEncoding = <span class="built_in">NSUTF8StringEncoding</span>;</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.mutableHTTPRequestHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">    <span class="keyword">self</span>.requestHeaderModificationQueue = dispatch_queue_create(<span class="string">"requestHeaderModificationQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</div><div class="line"></div><div class="line">    <span class="comment">// Accept-Language HTTP Header; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.4</span></div><div class="line">    <span class="built_in">NSMutableArray</span> *acceptLanguagesComponents = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">    [[<span class="built_in">NSLocale</span> preferredLanguages] enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</div><div class="line">        <span class="keyword">float</span> q = <span class="number">1.0</span>f - (idx * <span class="number">0.1</span>f);</div><div class="line">        [acceptLanguagesComponents addObject:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@;q=%0.1g"</span>, obj, q]];</div><div class="line">        *stop = q &lt;= <span class="number">0.5</span>f;</div><div class="line">    &#125;];</div><div class="line">    [<span class="keyword">self</span> setValue:[acceptLanguagesComponents componentsJoinedByString:<span class="string">@", "</span>] forHTTPHeaderField:<span class="string">@"Accept-Language"</span>];</div><div class="line"></div><div class="line">    <span class="built_in">NSString</span> *userAgent = <span class="literal">nil</span>;</div><div class="line">    <span class="comment">// User-Agent Header; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.43</span></div><div class="line">    userAgent = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@/%@ (%@; iOS %@; Scale/%0.2f)"</span>, [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleExecutableKey] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleIdentifierKey], [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][<span class="string">@"CFBundleShortVersionString"</span>] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleVersionKey], [[<span class="built_in">UIDevice</span> currentDevice] model], [[<span class="built_in">UIDevice</span> currentDevice] systemVersion], [[<span class="built_in">UIScreen</span> mainScreen] scale]];</div><div class="line">    <span class="keyword">if</span> (userAgent) &#123;</div><div class="line">        <span class="keyword">if</span> (![userAgent canBeConvertedToEncoding:<span class="built_in">NSASCIIStringEncoding</span>]) &#123;</div><div class="line">            <span class="built_in">NSMutableString</span> *mutableUserAgent = [userAgent mutableCopy];</div><div class="line">            <span class="keyword">if</span> (<span class="built_in">CFStringTransform</span>((__bridge <span class="built_in">CFMutableStringRef</span>)(mutableUserAgent), <span class="literal">NULL</span>, (__bridge <span class="built_in">CFStringRef</span>)<span class="string">@"Any-Latin; Latin-ASCII; [:^ASCII:] Remove"</span>, <span class="literal">false</span>)) &#123;</div><div class="line">                userAgent = mutableUserAgent;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        [<span class="keyword">self</span> setValue:userAgent forHTTPHeaderField:<span class="string">@"User-Agent"</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// HTTP Method Definitions; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html</span></div><div class="line">    <span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI = [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"GET"</span>, <span class="string">@"HEAD"</span>, <span class="string">@"DELETE"</span>, <span class="literal">nil</span>];</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.mutableObservedChangedKeyPaths = [<span class="built_in">NSMutableSet</span> set];</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</div><div class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="built_in">NSSelectorFromString</span>(keyPath)]) &#123;</div><div class="line">            [<span class="keyword">self</span> addObserver:<span class="keyword">self</span> forKeyPath:keyPath options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:AFHTTPRequestSerializerObserverContext];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>åˆå§‹åŒ–æ–¹æ³•ä¸»è¦æ˜¯å¯¹ä¸€äº›å±æ€§åˆå§‹åŒ–ï¼Œä»¥åŠå°†HTTPå¤´éƒ¨æŒ‰ç…§w3cæ ‡å‡†è¿›è¡Œäº†å°è£…ï¼Œæ ¹æ®<code>AFHTTPRequestSerializerObservedKeyPaths</code>æ–¹æ³•å¯¹ä¸€äº›å¿…è¦çš„å±æ€§ä½¿ç”¨KVOè¿›è¡Œäº†ç›‘å¬ã€‚åœ¨è¿™äº›è¢«ç›‘å¬çš„å±æ€§çš„setteré‡Œé¢æ‰‹åŠ¨åœ°å‘é€é€šçŸ¥ï¼Œé¿å…å‡ºç°<a href="https://github.com/AFNetworking/AFNetworking/issues/2523" target="_blank" rel="noopener">å¥‡æ€ªçš„å¼‚å¸¸</a>ï¼Œä¾‹å¦‚ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></div><div class="code"><pre><div class="line">- (<span class="keyword">void</span>)setCachePolicy:(<span class="built_in">NSURLRequestCachePolicy</span>)cachePolicy &#123;</div><div class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy))];</div><div class="line">    _cachePolicy = cachePolicy;</div><div class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy))];</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p><code>AFHTTPRequestSerializer</code>æ„å»ºä¸€èˆ¬çš„è¯·æ±‚çš„æµç¨‹:<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></div><div class="code"><pre><div class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestWithMethod:(<span class="built_in">NSString</span> *)method</div><div class="line">                                 URLString:(<span class="built_in">NSString</span> *)URLString</div><div class="line">                                parameters:(<span class="keyword">id</span>)parameters</div><div class="line">                                     error:(<span class="built_in">NSError</span> *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSParameterAssert</span>(method);</div><div class="line">    <span class="built_in">NSParameterAssert</span>(URLString);</div><div class="line"></div><div class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:URLString];</div><div class="line"></div><div class="line">    <span class="built_in">NSParameterAssert</span>(url);</div><div class="line"></div><div class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [[<span class="built_in">NSMutableURLRequest</span> alloc] initWithURL:url];</div><div class="line">    mutableRequest.HTTPMethod = method;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</div><div class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</div><div class="line">            [mutableRequest setValue:[<span class="keyword">self</span> valueForKeyPath:keyPath] forKey:keyPath];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mutableRequest = [[<span class="keyword">self</span> requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> mutableRequest;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>ä¸»è¦æ“ä½œæ˜¯å°†ä¿®æ”¹è¿‡çš„å±æ€§å¯¹ç…§ç€è®¾ç½®åˆ°<code>NSMutableURLRequest</code>ã€‚ç»§ç»­<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></div><div class="code"><pre><div class="line">- (<span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</div><div class="line">                               withParameters:(<span class="keyword">id</span>)parameters</div><div class="line">                                        error:(<span class="built_in">NSError</span> *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSParameterAssert</span>(request);</div><div class="line"></div><div class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [request mutableCopy];</div><div class="line"></div><div class="line">    [<span class="keyword">self</span>.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(<span class="keyword">id</span> field, <span class="keyword">id</span> value, <span class="built_in">BOOL</span> * __unused stop) &#123;</div><div class="line">        <span class="keyword">if</span> (![request valueForHTTPHeaderField:field]) &#123;</div><div class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">    <span class="built_in">NSString</span> *query = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">if</span> (parameters) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.queryStringSerialization) &#123;</div><div class="line">            <span class="built_in">NSError</span> *serializationError;</div><div class="line">            query = <span class="keyword">self</span>.queryStringSerialization(request, parameters, &amp;serializationError);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (serializationError) &#123;</div><div class="line">                <span class="keyword">if</span> (error) &#123;</div><div class="line">                    *error = serializationError;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">switch</span> (<span class="keyword">self</span>.queryStringSerializationStyle) &#123;</div><div class="line">                <span class="keyword">case</span> AFHTTPRequestQueryStringDefaultStyle:</div><div class="line">                    query = AFQueryStringFromParameters(parameters);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</div><div class="line">        <span class="keyword">if</span> (query &amp;&amp; query.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            mutableRequest.URL = [<span class="built_in">NSURL</span> URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? <span class="string">@"&amp;%@"</span> : <span class="string">@"?%@"</span>, query]];</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// #2864: an empty string is a valid x-www-form-urlencoded payload</span></div><div class="line">        <span class="keyword">if</span> (!query) &#123;</div><div class="line">            query = <span class="string">@""</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="string">@"Content-Type"</span>]) &#123;</div><div class="line">            [mutableRequest setValue:<span class="string">@"application/x-www-form-urlencoded"</span> forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</div><div class="line">        &#125;</div><div class="line">        [mutableRequest setHTTPBody:[query dataUsingEncoding:<span class="keyword">self</span>.stringEncoding]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> mutableRequest;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>è¿™ä¸€æ®µçš„ä¸»è¦åŠŸèƒ½æ˜¯å°†å‚æ•°è½¬æ¢æˆURLæŸ¥è¯¢è¯­å¥ï¼Œå¹¶æŠŠå…¶è®¾ç½®åˆ°HTTP Bodyé‡Œã€‚</p>
<h3 id="ä¸Šä¼ æ–‡ä»¶"><a href="#ä¸Šä¼ æ–‡ä»¶" class="headerlink" title="ä¸Šä¼ æ–‡ä»¶"></a>ä¸Šä¼ æ–‡ä»¶</h3><p>åœ¨äº†è§£è¿™éƒ¨åˆ†ä»£ç ä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ä¸€ä¸‹HTTPåè®®å…³äºä¼ è¾“multipartæ•°æ®çš„ç›¸å…³çº¦å®šã€‚æ ¹æ®<a href="https://www.ietf.org/rfc/rfc1867.txt" target="_blank" rel="noopener">rfc1867</a>è§„å®šï¼Œä¼ è¾“multipartå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¾‹å­çš„æ ¼å¼ï¼š<br><figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></div><div class="code"><pre><div class="line"><span class="attribute">Content-type</span>: multipart/form-data, boundary=AaB03x</div><div class="line"></div><div class="line">--AaB03x</div><div class="line"><span class="attribute">content-disposition</span>: form-data; name="userName"</div><div class="line"></div><div class="line">Joe Blow</div><div class="line"></div><div class="line">--AaB03x</div><div class="line"><span class="attribute">content-disposition</span>: form-data; name="pics[]"; filename="pic1.png"</div><div class="line"><span class="attribute">Content-Type</span>: image/png</div><div class="line"></div><div class="line"> ... contents of pic1.png ...</div><div class="line"> </div><div class="line">--AaB03x</div><div class="line"><span class="attribute">Content-disposition</span>: form-data; name="pics[]"; filename="pic2.png"</div><div class="line"><span class="attribute">Content-type</span>: image/png</div><div class="line"></div><div class="line">... contents of pic2.png ...</div><div class="line"></div><div class="line">--AaB03x--</div></pre></div></div></figure></p>
<p>å®šä¹‰ä¸€ä¸ªè¾¹ç•Œboundaryï¼Œæ¯ä¸ªä¸Šä¼ çš„å„ä¸ªéƒ¨åˆ†ï¼ˆPartï¼‰ç”¨<code>--boundary</code>æ¥åˆ†å‰²ï¼Œå†ä»¥<code>--boundary--</code>ä¸ºç»“å°¾ã€‚nameä¸ºæœåŠ¡å™¨ç«¯è·å–æ–‡ä»¶æ—¶ä½¿ç”¨çš„å‚æ•°ï¼Œfilenameä¸ºæœ¬åœ°çš„æ–‡ä»¶åã€‚</p>
<p>AFNetworkingä¸»è¦æ˜¯é€šè¿‡æµï¼ˆStreamï¼‰çš„æ–¹å¼æ¥ä¸Šä¼ æ–‡ä»¶ï¼Œå› æ­¤<code>AFHTTPRequestSerializer</code>æä¾›äº†æœ€åŸºæœ¬çš„æµå¤„ç†æ–¹æ³•ã€‚<br><code>AFHTTPRequestSerializer</code>ä½¿ç”¨<code>AFMultipartFormData</code>åè®®æ¥å®šä¹‰ç”¨æˆ·ä¼ å…¥éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶æˆ–è€…æ•°æ®çš„æ–¹æ³•ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå®ç°äº†è¯¥åè®®çš„ç±»æ¥ç®¡ç†æ–‡ä»¶çš„ä¸Šä¼ ã€‚é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ¥ç”Ÿæˆä¸€ä¸ªåŒ…å«æ–‡ä»¶æµçš„Requestï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    æ ¹æ®æŒ‡å®šè¯·æ±‚æ–¹æ³•ã€URLå’Œå‚æ•°ä»¥åŠBlockæ„é€ çš„multipart/form-dataç±»å‹çš„HTTP bodyï¼Œè¿”å›ä¸€ä¸ªNSMutableURLRequestå¯¹è±¡ã€‚</span></div><div class="line"><span class="comment">    è¯·æ±‚çš„å¤šéƒ¨åˆ†ï¼ˆMultipartï¼‰è‡ªåŠ¨ä»¥æµï¼ˆstreamï¼‰çš„å½¢å¼ä»ç¡¬ç›˜æˆ–è€…å†…å­˜ä¸­è¯»å–æ•°æ®åˆ°HTTP bodyã€‚</span></div><div class="line"><span class="comment">    è¿™å¯¼è‡´ç”Ÿæˆçš„NSMutableURLRequestå¯¹è±¡æœ‰ä¸€ä¸ªHTTPBodyStreamå±æ€§ï¼Œæ‰€ä»¥ä¸è¦å†è®¾ç½®HTTPBodyStreamæˆ–è€…HTTPBodyç»™è¿™ä¸ªå¯¹è±¡ï¼Œä»¥é¿å…è¦†ç›–æ‰æµæ•°æ®ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line">- (<span class="built_in">NSMutableURLRequest</span> *)multipartFormRequestWithMethod:(<span class="built_in">NSString</span> *)method</div><div class="line">                                              URLString:(<span class="built_in">NSString</span> *)URLString</div><div class="line">                                             parameters:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)parameters</div><div class="line">                              constructingBodyWithBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="keyword">id</span> &lt;AFMultipartFormData&gt; formData))block</div><div class="line">                                                  error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</div></pre></div></div></figure></p>
<p>è¿™ä¸ªè¿‡ç¨‹ä¸»è¦æ¶‰åŠåˆ°äº†ä»¥ä¸‹ä¸‰ä¸ªç±»ï¼š</p>
<ul>
<li><code>AFStreamingMultipartFormData</code>å°±æ˜¯å®ç°äº†<code>AFMultipartFormData</code>åè®®å®šä¹‰çš„æ·»åŠ ä¸Šä¼ æ–‡ä»¶æ–¹æ³•çš„ç±»ã€‚</li>
<li><code>AFMultipartBodyStream</code>ç»§æ‰¿äº†NSInputStreamï¼Œç®¡ç†å¾…ä¸Šä¼ çš„æ–‡ä»¶æµçš„è¯»å–æ“ä½œï¼Œæ˜¯ä½œä¸ºç”Ÿæˆçš„requestçš„HTTPBodyStreamã€‚å› ä¸ºNSInputStreamæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼ˆabstract classï¼‰ï¼Œæ‰€ä»¥å®ƒçš„å­ç±»éƒ½å¿…é¡»å»é‡æ–°å®ç°å®ƒçš„æ–¹æ³•ã€‚<code>AFMultipartBodyStream</code>ä¸»è¦å®ç°äº†NSInputStreamçš„çš„<code>-read:maxLength:</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®šä¹‰äº†æµçš„è¯»å–æ–¹å¼ã€‚</li>
<li><code>AFHTTPBodyPart</code>ç®¡ç†ç€å•ä¸ªæ–‡ä»¶ï¼Œå°è£…äº†HTTPä¸Šä¼ åè®®ä¸­çš„æ¯ä¸ªéƒ¨åˆ†Partï¼Œheaderä¿å­˜ç€<code>Content-disposition</code>å’Œ<code>Content-type</code>æ•°æ®ï¼Œç›¸äº’ä¹‹é—´ç”¨<code>--boundary</code>åˆ†éš”ã€‚</li>
</ul>
<p><code>AFStreamingMultipartFormData</code>ç±»çš„ä¸»è¦å±æ€§å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/** éœ€è¦ç”Ÿæˆçš„request */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSMutableURLRequest</span> *request;</div><div class="line"><span class="comment">/** ç¼–ç æ–¹å¼ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</div><div class="line"><span class="comment">/** ä½¿ç”¨AFCreateMultipartFormBoundary()ç”Ÿæˆçš„éšæœºå€¼æ˜¨æ™šBoundary */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *boundary;</div><div class="line"><span class="comment">/** ç”Ÿæˆrequestçš„bodyStream */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFMultipartBodyStream *bodyStream;</div></pre></div></div></figure></p>
<p><code>AFStreamingMultipartFormData</code>å®ç°<code>AFMultipartFormData</code>åè®®ä¸­æ·»åŠ æ–‡ä»¶çš„æ–¹æ³•éƒ½æ˜¯é€šè¿‡æ„å»ºä¸€ä¸ªæ–°çš„<code>AFHTTPBodyPart</code>å†æ·»åŠ åˆ°bodyStreamï¼Œå†ç”±bodyStreamå»å¤„ç†ã€‚</p>
<p><code>AFMultipartBodyStream</code>ç±»çš„ä¸»è¦å±æ€§å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/** ç¼–ç æ–¹å¼ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</div><div class="line"><span class="comment">/** ä¸€ä¸ªå­˜å‚¨ç€AFHTTPBodyPartçš„æ•°ç»„ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> *HTTPBodyParts;</div><div class="line"><span class="comment">/** åœ¨æµopenæ—¶ï¼Œè®°å½•HTTPBodyPartsçš„è¿­ä»£å™¨ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSEnumerator</span> *HTTPBodyPartEnumerator;</div><div class="line"><span class="comment">/** å½“å‰æ­£åœ¨è¯»å–çš„AFHTTPBodyPart */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFHTTPBodyPart *currentHTTPBodyPart;</div><div class="line"><span class="comment">/** ä»¥ä¸‹ä¸¤ä¸ªå±æ€§ä¼šå½±å“è¯»å–é€Ÿåº¦å’Œæ‰€å CUPèµ„æºï¼Œå¦‚æœå½“å‰å¤„ç†çš„äº‹åŠ¡è¾ƒå¤šï¼Œå¯ä»¥ä¿®æ”¹è¿™ä¸¤å±æ€§ä»¥é¿å…é€ æˆç•Œé¢å¡é¡¿ã€‚ */</span></div><div class="line"><span class="comment">/** æ¯æ¬¡è¯»å–æ•°æ®çš„å­—èŠ‚æ•° */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> numberOfBytesInPacket;</div><div class="line"><span class="comment">/** æ¯æ¬¡è¯»å–é—´éš”æ—¶é—´ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> delay;</div></pre></div></div></figure></p>
<p><code>AFMultipartBodyStream</code>ä¸»è¦çš„åŠŸèƒ½æ˜¯ä»ç¡¬ç›˜æˆ–è€…å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></div><div class="code"><pre><div class="line">- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer</div><div class="line">        maxLength:(<span class="built_in">NSUInteger</span>)length</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> streamStatus] == <span class="built_in">NSStreamStatusClosed</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">NSInteger</span> totalNumberOfBytesRead = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> ((<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead &lt; MIN(length, <span class="keyword">self</span>.numberOfBytesInPacket)) &#123;</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.currentHTTPBodyPart || ![<span class="keyword">self</span>.currentHTTPBodyPart hasBytesAvailable]) &#123;</div><div class="line">            <span class="keyword">if</span> (!(<span class="keyword">self</span>.currentHTTPBodyPart = [<span class="keyword">self</span>.HTTPBodyPartEnumerator nextObject])) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">NSUInteger</span> maxLength = MIN(length, <span class="keyword">self</span>.numberOfBytesInPacket) - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead;</div><div class="line">            <span class="built_in">NSInteger</span> numberOfBytesRead = [<span class="keyword">self</span>.currentHTTPBodyPart read:&amp;buffer[totalNumberOfBytesRead] maxLength:maxLength];</div><div class="line">            <span class="keyword">if</span> (numberOfBytesRead == <span class="number">-1</span>) &#123;</div><div class="line">                <span class="keyword">self</span>.streamError = <span class="keyword">self</span>.currentHTTPBodyPart.inputStream.streamError;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                totalNumberOfBytesRead += numberOfBytesRead;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.delay &gt; <span class="number">0.0</span>f) &#123;</div><div class="line">                    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="keyword">self</span>.delay];</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> totalNumberOfBytesRead;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>ç”±ä»¥ä¸Šä»£ç å¯ä»¥çœ‹å‡ºï¼Œè¯»å–çš„å·¥ä½œåˆ†é…åˆ°å„ä¸ª<code>AFHTTPBodyPart</code>å»å®Œæˆã€‚</p>
<p><code>AFHTTPBodyPart</code>çš„ä¸»è¦å±æ€§ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/** ç¼–ç æ–¹å¼ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</div><div class="line"><span class="comment">/** å¤´éƒ¨æè¿° */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> *headers;</div><div class="line"><span class="comment">/** boundaryæ ‡è¯†ç¬¦ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *boundary;</div><div class="line"><span class="comment">/** ä¸Šä¼ çš„å¯¹è±¡ï¼Œå¯ä»¥æ˜¯NSDataã€NSURLã€NSInputStream */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> body;</div><div class="line"><span class="comment">/** æ–‡ä»¶å¤§å° */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> bodyContentLength;</div><div class="line"><span class="comment">/** æ•´ä¸ªæµè¯»å–è¿‡ç¨‹ä¸­æœ€åŸºæœ¬çš„è¯»å–æ–‡ä»¶æµ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSInputStream</span> *inputStream;</div><div class="line"></div><div class="line"><span class="comment">/** æ˜¯å¦æ˜¯é¦–ä¸ªæ–‡ä»¶ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> hasInitialBoundary;</div><div class="line"><span class="comment">/** æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªæ–‡ä»¶ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> hasFinalBoundary;</div><div class="line"></div><div class="line"><span class="comment">/** ç§æœ‰å˜é‡ */</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">	AFHTTPBodyPartæ˜¯åˆ†é˜¶æ®µè¯»å–çš„ï¼Œåˆ†åˆ«è¯»å–boundaryéƒ¨åˆ†ï¼Œheaderéƒ¨åˆ†å’Œbodyéƒ¨åˆ†ã€‚è¿™å®ä¾‹å˜é‡æ ‡å‡†ç€ç›®å‰é˜¶æ®µã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line">AFHTTPBodyPartReadPhase _phase;</div><div class="line"><span class="comment">/** æ•°æ®åç§»é‡ */</span></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> _phaseReadOffset;</div></pre></div></div></figure></p>
<p><code>AFHTTPBodyPart</code>å°†è¯»å–æ•°æ®åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µè¿›è¡Œï¼Œä¸€ä¸ªé˜¶æ®µè¯»å®Œåˆ™è¿›è¡Œä¸‹ä¸€ä¸ªé˜¶æ®µï¼Œä¸»è¦ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></div><div class="code"><pre><div class="line">- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer</div><div class="line">        maxLength:(<span class="built_in">NSUInteger</span>)length</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSInteger</span> totalNumberOfBytesRead = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (_phase == AFEncapsulationBoundaryPhase) &#123;</div><div class="line">        <span class="built_in">NSData</span> *encapsulationBoundaryData = [([<span class="keyword">self</span> hasInitialBoundary] ? AFMultipartFormInitialBoundary(<span class="keyword">self</span>.boundary) : AFMultipartFormEncapsulationBoundary(<span class="keyword">self</span>.boundary)) dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</div><div class="line">        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:encapsulationBoundaryData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (_phase == AFHeaderPhase) &#123;</div><div class="line">        <span class="built_in">NSData</span> *headersData = [[<span class="keyword">self</span> stringForHeaders] dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</div><div class="line">        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:headersData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (_phase == AFBodyPhase) &#123;</div><div class="line">        <span class="built_in">NSInteger</span> numberOfBytesRead = <span class="number">0</span>;</div><div class="line">        </div><div class="line">        numberOfBytesRead = [<span class="keyword">self</span>.inputStream read:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</div><div class="line">        <span class="keyword">if</span> (numberOfBytesRead == <span class="number">-1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            totalNumberOfBytesRead += numberOfBytesRead;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span>.inputStream streamStatus] &gt;= <span class="built_in">NSStreamStatusAtEnd</span>) &#123;</div><div class="line">                [<span class="keyword">self</span> transitionToNextPhase];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (_phase == AFFinalBoundaryPhase) &#123;</div><div class="line">        <span class="built_in">NSData</span> *closingBoundaryData = ([<span class="keyword">self</span> hasFinalBoundary] ? [AFMultipartFormFinalBoundary(<span class="keyword">self</span>.boundary) dataUsingEncoding:<span class="keyword">self</span>.stringEncoding] : [<span class="built_in">NSData</span> data]);</div><div class="line">        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:closingBoundaryData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> totalNumberOfBytesRead;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<h3 id="AFHTTPRequestSerializerå­ç±»"><a href="#AFHTTPRequestSerializerå­ç±»" class="headerlink" title="AFHTTPRequestSerializerå­ç±»"></a>AFHTTPRequestSerializerå­ç±»</h3><p><code>AFHTTPRequestSerializer</code>çš„å­ç±»ä¸»è¦æ˜¯å¯¹å‚æ•°çš„æ ¼å¼è¿›è¡Œæ‰©å±•ã€‚<br><code>AFJSONRequestSerializer</code>å°†å‚æ•°è½¬æ¢æˆJSONæ ¼å¼å†ä»¥<code>Content-Type : application/json</code>çš„æ–¹å¼ç”Ÿæˆrequestã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></div><div class="code"><pre><div class="line"><span class="keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="string">@"Content-Type"</span>]) &#123;</div><div class="line">    [mutableRequest setValue:<span class="string">@"application/json"</span> forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (![<span class="built_in">NSJSONSerialization</span> isValidJSONObject:parameters]) &#123;</div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        <span class="built_in">NSDictionary</span> *userInfo = @&#123;<span class="built_in">NSLocalizedFailureReasonErrorKey</span>: <span class="built_in">NSLocalizedStringFromTable</span>(<span class="string">@"The `parameters` argument is not valid JSON."</span>, <span class="string">@"AFNetworking"</span>, <span class="literal">nil</span>)&#125;;</div><div class="line">        *error = [[<span class="built_in">NSError</span> alloc] initWithDomain:AFURLRequestSerializationErrorDomain code:<span class="built_in">NSURLErrorCannotDecodeContentData</span> userInfo:userInfo];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p><code>AFPropertyListRequestSerializer</code>å°†å‚æ•°è½¬æ¢æˆplistæ ¼å¼å†ä»¥<code>Content-Type : application/x-plist</code>çš„æ–¹å¼ç”Ÿæˆrequestã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></div><div class="code"><pre><div class="line"><span class="keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="string">@"Content-Type"</span>]) &#123;</div><div class="line">    [mutableRequest setValue:<span class="string">@"application/x-plist"</span> forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">NSData</span> *plistData = [<span class="built_in">NSPropertyListSerialization</span> dataWithPropertyList:parameters format:<span class="keyword">self</span>.format options:<span class="keyword">self</span>.writeOptions error:error];</div></pre></div></div></figure></p>
<h2 id="AFURLResponseSerialization-h"><a href="#AFURLResponseSerialization-h" class="headerlink" title="AFURLResponseSerialization.h"></a>AFURLResponseSerialization.h</h2><p>åŒæ ·æ˜¯é€šè¿‡åè®®å®šä¹‰åºåˆ—åŒ–æ–¹æ³•ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    AFURLResponseSerializationåè®®æ˜¯ç”¨äºå°†æ•°æ®æ ¹æ®æœåŠ¡å™¨è¿”å›çš„è¯¦ç»†ä¿¡æ¯è§£ç æˆæ›´æœ‰æ•ˆçš„å¯¹è±¡è¡¨ç¤ºï¼ˆobject representationï¼‰ã€‚å›å¤åºåˆ—åŒ–å™¨ï¼ˆResponse serializersï¼‰è¿˜å¯ä»¥ä¸ºè¿”å›çš„æ•°æ®æä¾›æ ¡éªŒã€‚</span></div><div class="line"><span class="comment">    ä¾‹å¦‚ï¼šä¸€ä¸ªJSON response serializer å¯èƒ½åœ¨æ£€æµ‹çŠ¶æ€ç ï¼ˆâ€™2xxâ€™èŒƒå›´å†…ï¼‰å’ŒContent-Typeï¼ˆâ€˜application/jsonâ€™ï¼‰åï¼Œå°†JSON responseè§£ç ä¸€ä¸ªå¯¹è±¡ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">AFURLResponseSerialization</span> &lt;<span class="title">NSObject</span>, <span class="title">NSSecureCoding</span>, <span class="title">NSCopying</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    æ ¹æ®æŒ‡å®šresponseè¿”å›çš„ç¼–ç å¯¹è±¡ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)responseObjectForResponse:(<span class="keyword">nullable</span> <span class="built_in">NSURLResponse</span> *)response</div><div class="line">                           data:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)data</div><div class="line">                          error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error <span class="built_in">NS_SWIFT_NOTHROW</span>;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></div></div></figure></p>
<p><code>AFHTTPResponseSerializer</code>å®ç°äº†<code>AFURLResponseSerialization</code>åè®®ï¼Œå› ä¸ºæœåŠ¡å™¨è¿”å›çš„HTTPæŠ¥æ–‡ä¸€èˆ¬éƒ½æœ‰æ˜ç¡®çš„æ•°æ®ç±»å‹ï¼ˆContent-Typeï¼‰ï¼Œæ‰€ä»¥å¯¹è¿™äº›æ•°æ®çš„å¤„ç†å…·ä½“éƒ½åœ¨å„ä¸ªå­ç±»ä¸­å®ç°ã€‚<code>AFHTTPResponseSerializer</code>çš„å±æ€§æ¯”è¾ƒå°‘ï¼Œåªæœ‰ä»¥ä¸‹ä¸¤ä¸ªï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    å¯æ¥å—çš„çŠ¶æ€ç ã€‚å½“ä¸ä¸ºnilæ—¶ï¼Œå¦‚æœè¿”å›çš„çŠ¶æ€ç ä¸åŒ…å«åœ¨è¯¥setä¸­å°†åœ¨æ ¡éªŒè¿‡ç¨‹ä¸­å¯¼è‡´é”™è¯¯ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="built_in">NSIndexSet</span> *acceptableStatusCodes;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    å¯æ¥å—çš„MIMEç±»å‹ã€‚å½“ä¸ä¸ºnilæ—¶ï¼Œå¦‚æœè¿”å›çš„Content-Typeä¸åŒ…å«åœ¨è¯¥setä¸­å°†åœ¨æ ¡éªŒè¿‡ç¨‹ä¸­å¯¼è‡´é”™è¯¯ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="built_in">NSSet</span> &lt;<span class="built_in">NSString</span> *&gt; *acceptableContentTypes;</div></pre></div></div></figure></p>
<p>æ­¤å¤–ï¼Œ<code>AFHTTPResponseSerializer</code>ä¸ºæ‰€æœ‰å­ç±»ç»Ÿä¸€äº†ä¸€ä¸ªæ ¡éªŒæ–¹æ³•ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    æ ¡éªŒæŒ‡å®šçš„è¿”å›å’Œæ•°æ®ã€‚</span></div><div class="line"><span class="comment">    åœ¨å®ƒçš„åŸºç¡€å®ç°ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•æ£€æµ‹äº†å¯æ¥å—çš„çŠ¶æ€ç å’Œæ•°æ®ç±»å‹ã€‚å­ç±»å¯ä»¥æ·»åŠ å…¶ä»–ç‰¹å®šçš„æ£€æµ‹ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line">- (<span class="built_in">BOOL</span>)validateResponse:(<span class="keyword">nullable</span> <span class="built_in">NSHTTPURLResponse</span> *)response</div><div class="line">                    data:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)data</div><div class="line">                   error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</div></pre></div></div></figure></p>
<h2 id="AFURLResponseSerialization-m"><a href="#AFURLResponseSerialization-m" class="headerlink" title="AFURLResponseSerialization.m"></a>AFURLResponseSerialization.m</h2><p>å¯¹æœåŠ¡å™¨çš„å“åº”æ•°æ®åºåˆ—åŒ–ç›¸å¯¹ç®€å•ç‚¹ï¼Œä¸»è¦æ˜¯æŒ‰ç…§æœåŠ¡å™¨è¿”å›æ•°æ®çš„ç±»å‹ä½¿ç”¨ç›¸åº”çš„å­ç±»å°†æ•°æ®è½¬æ¢æˆå¯¹åº”çš„Cocoaå¯¹è±¡ã€‚ä¸»è¦å®ç°çš„éªŒè¯æ–¹æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></div><div class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>)validateResponse:(<span class="built_in">NSHTTPURLResponse</span> *)response</div><div class="line">                    data:(<span class="built_in">NSData</span> *)data</div><div class="line">                   error:(<span class="built_in">NSError</span> * __autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    <span class="built_in">BOOL</span> responseIsValid = <span class="literal">YES</span>;</div><div class="line">    <span class="built_in">NSError</span> *validationError = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (response &amp;&amp; [response isKindOfClass:[<span class="built_in">NSHTTPURLResponse</span> <span class="keyword">class</span>]]) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.acceptableContentTypes &amp;&amp; ![<span class="keyword">self</span>.acceptableContentTypes containsObject:[response MIMEType]] &amp;&amp;</div><div class="line">            !([response MIMEType] == <span class="literal">nil</span> &amp;&amp; [data length] == <span class="number">0</span>)) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ([data length] &gt; <span class="number">0</span> &amp;&amp; [response URL]) &#123;</div><div class="line">                <span class="built_in">NSMutableDictionary</span> *mutableUserInfo = [@&#123;</div><div class="line">                                                          <span class="built_in">NSLocalizedDescriptionKey</span>: [<span class="built_in">NSString</span> stringWithFormat:<span class="built_in">NSLocalizedStringFromTable</span>(<span class="string">@"Request failed: unacceptable content-type: %@"</span>, <span class="string">@"AFNetworking"</span>, <span class="literal">nil</span>), [response MIMEType]],</div><div class="line">                                                          <span class="built_in">NSURLErrorFailingURLErrorKey</span>:[response URL],</div><div class="line">                                                          AFNetworkingOperationFailingURLResponseErrorKey: response,</div><div class="line">                                                        &#125; mutableCopy];</div><div class="line">                <span class="keyword">if</span> (data) &#123;</div><div class="line">                    mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                validationError = AFErrorWithUnderlyingError([<span class="built_in">NSError</span> errorWithDomain:AFURLResponseSerializationErrorDomain code:<span class="built_in">NSURLErrorCannotDecodeContentData</span> userInfo:mutableUserInfo], validationError);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            responseIsValid = <span class="literal">NO</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.acceptableStatusCodes &amp;&amp; ![<span class="keyword">self</span>.acceptableStatusCodes containsIndex:(<span class="built_in">NSUInteger</span>)response.statusCode] &amp;&amp; [response URL]) &#123;</div><div class="line">            <span class="built_in">NSMutableDictionary</span> *mutableUserInfo = [@&#123;</div><div class="line">                                               <span class="built_in">NSLocalizedDescriptionKey</span>: [<span class="built_in">NSString</span> stringWithFormat:<span class="built_in">NSLocalizedStringFromTable</span>(<span class="string">@"Request failed: %@ (%ld)"</span>, <span class="string">@"AFNetworking"</span>, <span class="literal">nil</span>), [<span class="built_in">NSHTTPURLResponse</span> localizedStringForStatusCode:response.statusCode], (<span class="keyword">long</span>)response.statusCode],</div><div class="line">                                               <span class="built_in">NSURLErrorFailingURLErrorKey</span>:[response URL],</div><div class="line">                                               AFNetworkingOperationFailingURLResponseErrorKey: response,</div><div class="line">                                       &#125; mutableCopy];</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (data) &#123;</div><div class="line">                mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            validationError = AFErrorWithUnderlyingError([<span class="built_in">NSError</span> errorWithDomain:AFURLResponseSerializationErrorDomain code:<span class="built_in">NSURLErrorBadServerResponse</span> userInfo:mutableUserInfo], validationError);</div><div class="line"></div><div class="line">            responseIsValid = <span class="literal">NO</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (error &amp;&amp; !responseIsValid) &#123;</div><div class="line">        *error = validationError;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> responseIsValid;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>å®ç°çš„å­ç±»å¦‚ä¸‹ï¼š<br><code>AFJSONResponseSerializer</code>è§£æJSONæ•°æ®ï¼Œå…³é”®ä»£ç ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></div><div class="code"><pre><div class="line"><span class="keyword">self</span>.acceptableContentTypes = [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"application/json"</span>, <span class="string">@"text/json"</span>, <span class="string">@"text/javascript"</span>, <span class="literal">nil</span>];</div><div class="line"><span class="keyword">id</span> responseObject = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:data options:<span class="keyword">self</span>.readingOptions error:&amp;serializationError];</div><div class="line"></div><div class="line"><span class="comment">//é€šè¿‡è®¾ç½®removesKeysWithNullValuesæ¥ç§»é™¤Nullå€¼</span></div><div class="line">AFJSONObjectByRemovingKeysWithNullValues(responseObject, <span class="keyword">self</span>.readingOptions);</div></pre></div></div></figure></p>
<p><code>AFXMLParserResponseSerializer</code>è§£æXMLæ•°æ®ï¼Œå…³é”®ä»£ç ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></div><div class="code"><pre><div class="line"><span class="keyword">self</span>.acceptableContentTypes = [[<span class="built_in">NSSet</span> alloc] initWithObjects:<span class="string">@"application/xml"</span>, <span class="string">@"text/xml"</span>, <span class="literal">nil</span>];</div><div class="line">[[<span class="built_in">NSXMLParser</span> alloc] initWithData:data];</div></pre></div></div></figure></p>
<p><code>AFPropertyListResponseSerializer</code>è§£æplistæ•°æ®ï¼Œå…³é”®ä»£ç ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></div><div class="code"><pre><div class="line"><span class="keyword">self</span>.acceptableContentTypes = [[<span class="built_in">NSSet</span> alloc] initWithObjects:<span class="string">@"application/x-plist"</span>, <span class="literal">nil</span>];</div><div class="line"><span class="keyword">id</span> responseObject = [<span class="built_in">NSPropertyListSerialization</span> propertyListWithData:data options:<span class="keyword">self</span>.readOptions format:<span class="literal">NULL</span> error:&amp;serializationError];</div></pre></div></div></figure></p>
<p>æ‰€æœ‰å­ç±»ä¸­ï¼Œå€¼å¾—è¯¦ç»†äº†è§£çš„æ˜¯<code>AFImageResponseSerializer</code>ï¼Œè¿™ä¸ªç”¨æ¥è§£æå›¾ç‰‡æ•°æ®çš„ç±»ã€‚è¿™ä¸ªç±»æä¾›äº†ä¸¤ä¸ªå±æ€§å¯ä¾›è®¾ç½®ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    å½“è§£æå›¾ç‰‡æ•°æ®å»æ„é€ responseImageå¯¹è±¡æ—¶ï¼Œä½¿ç”¨åˆ°scaleå› æ•°ã€‚å½“scaleå› æ•°ä¸º1.0æ—¶ï¼Œç”Ÿæˆå›¾ç‰‡çš„sizeå°†åŒ¹é…è¯¥å›¾ç‰‡çš„åƒç´ å°ºå¯¸ã€‚</span></div><div class="line"><span class="comment">    ä½¿ç”¨å…¶ä»–scaleå› æ•°æ—¶ï¼Œå°†ä¾æ®sizeå±æ€§å»æ”¹å˜å›¾ç‰‡çš„sizeã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼å°†è¢«è®¾ç½®ä¸ºmainScreençš„scaleå€¼ï¼Œè¿™ä¼šè‡ªåŠ¨æ‹‰ä¼¸å›¾ç‰‡å»é€‚é…retinaå±çš„å±•ç¤ºã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> imageScale;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    æ˜¯å¦æ ¹æ®å‹ç¼©æ ¼å¼ï¼ˆä¾‹å¦‚ï¼šPNGæˆ–è€…JPEGï¼‰è‡ªåŠ¨è§£å‹è¿”å›çš„å›¾ç‰‡ã€‚</span></div><div class="line"><span class="comment">    åœ¨iOSç³»ç»Ÿä¸­å½“ä½¿ç”¨setCompletionBlockWithSuccess:failure:æ–¹æ³•æ—¶å…è®¸è¿™ä¸ªå€¼å°†å¸¦æ¥æœ‰æ•ˆçš„ç»˜ç”»æ€§èƒ½çš„æå‡ï¼Œå› ä¸ºå®ƒå…è®¸åœ¨åå°æ„é€ ä¸€å¼ ä½å›¾è€Œä¸æ˜¯åœ¨ä¸»çº¿ç¨‹ã€‚é»˜è®¤ä¸ºYESã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> automaticallyInflatesResponseImage;</div></pre></div></div></figure></p>
<p>è¿™ä¸ªç±»é™¤äº†è·Ÿå…¶ä»–å­ç±»ä¸€æ ·æä¾›è§£æè¿”å›çš„æ•°æ®å¤–ï¼Œè¿˜æä¾›äº†å°†è¿”å›çš„å›¾ç‰‡åœ¨åå°çº¿ç¨‹è§£å‹çš„é¢å¤–åŠŸèƒ½ï¼Œå…·ä½“çš„è§£å‹ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></div><div class="code"><pre><div class="line"><span class="keyword">static</span> <span class="built_in">UIImage</span> * AFInflatedImageFromResponseWithDataAtScale(<span class="built_in">NSHTTPURLResponse</span> *response, <span class="built_in">NSData</span> *data, <span class="built_in">CGFloat</span> scale) &#123;</div><div class="line">    <span class="keyword">if</span> (!data || [data length] == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">CGImageRef</span> imageRef = <span class="literal">NULL</span>;</div><div class="line">    <span class="built_in">CGDataProviderRef</span> dataProvider = <span class="built_in">CGDataProviderCreateWithCFData</span>((__bridge <span class="built_in">CFDataRef</span>)data);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ([response.MIMEType isEqualToString:<span class="string">@"image/png"</span>]) &#123;</div><div class="line">        imageRef = <span class="built_in">CGImageCreateWithPNGDataProvider</span>(dataProvider,  <span class="literal">NULL</span>, <span class="literal">true</span>, kCGRenderingIntentDefault);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([response.MIMEType isEqualToString:<span class="string">@"image/jpeg"</span>]) &#123;</div><div class="line">        imageRef = <span class="built_in">CGImageCreateWithJPEGDataProvider</span>(dataProvider, <span class="literal">NULL</span>, <span class="literal">true</span>, kCGRenderingIntentDefault);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (imageRef) &#123;</div><div class="line">            <span class="built_in">CGColorSpaceRef</span> imageColorSpace = <span class="built_in">CGImageGetColorSpace</span>(imageRef);</div><div class="line">            <span class="built_in">CGColorSpaceModel</span> imageColorSpaceModel = <span class="built_in">CGColorSpaceGetModel</span>(imageColorSpace);</div><div class="line"></div><div class="line">            <span class="comment">// CGImageCreateWithJPEGDataProvider does not properly handle CMKY, so fall back to AFImageWithDataAtScale</span></div><div class="line">            <span class="keyword">if</span> (imageColorSpaceModel == kCGColorSpaceModelCMYK) &#123;</div><div class="line">                <span class="built_in">CGImageRelease</span>(imageRef);</div><div class="line">                imageRef = <span class="literal">NULL</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">CGDataProviderRelease</span>(dataProvider);</div><div class="line"></div><div class="line">    <span class="built_in">UIImage</span> *image = AFImageWithDataAtScale(data, scale);</div><div class="line">    <span class="keyword">if</span> (!imageRef) &#123;</div><div class="line">        <span class="keyword">if</span> (image.images || !image) &#123;</div><div class="line">            <span class="keyword">return</span> image;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        imageRef = <span class="built_in">CGImageCreateCopy</span>([image <span class="built_in">CGImage</span>]);</div><div class="line">        <span class="keyword">if</span> (!imageRef) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    size_t width = <span class="built_in">CGImageGetWidth</span>(imageRef);</div><div class="line">    size_t height = <span class="built_in">CGImageGetHeight</span>(imageRef);</div><div class="line">    size_t bitsPerComponent = <span class="built_in">CGImageGetBitsPerComponent</span>(imageRef);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (width * height &gt; <span class="number">1024</span> * <span class="number">1024</span> || bitsPerComponent &gt; <span class="number">8</span>) &#123;</div><div class="line">        <span class="built_in">CGImageRelease</span>(imageRef);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> image;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// CGImageGetBytesPerRow() calculates incorrectly in iOS 5.0, so defer to CGBitmapContextCreate</span></div><div class="line">    size_t bytesPerRow = <span class="number">0</span>;</div><div class="line">    <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceRGB</span>();</div><div class="line">    <span class="built_in">CGColorSpaceModel</span> colorSpaceModel = <span class="built_in">CGColorSpaceGetModel</span>(colorSpace);</div><div class="line">    <span class="built_in">CGBitmapInfo</span> bitmapInfo = <span class="built_in">CGImageGetBitmapInfo</span>(imageRef);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (colorSpaceModel == kCGColorSpaceModelRGB) &#123;</div><div class="line">        uint32_t alpha = (bitmapInfo &amp; kCGBitmapAlphaInfoMask);</div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wassign-enum"</span></span></div><div class="line">        <span class="keyword">if</span> (alpha == kCGImageAlphaNone) &#123;</div><div class="line">            bitmapInfo &amp;= ~kCGBitmapAlphaInfoMask;</div><div class="line">            bitmapInfo |= kCGImageAlphaNoneSkipFirst;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(alpha == kCGImageAlphaNoneSkipFirst || alpha == kCGImageAlphaNoneSkipLast)) &#123;</div><div class="line">            bitmapInfo &amp;= ~kCGBitmapAlphaInfoMask;</div><div class="line">            bitmapInfo |= kCGImageAlphaPremultipliedFirst;</div><div class="line">        &#125;</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(<span class="literal">NULL</span>, width, height, bitsPerComponent, bytesPerRow, colorSpace, bitmapInfo);</div><div class="line"></div><div class="line">    <span class="built_in">CGColorSpaceRelease</span>(colorSpace);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!context) &#123;</div><div class="line">        <span class="built_in">CGImageRelease</span>(imageRef);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> image;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0.0</span>f, <span class="number">0.0</span>f, width, height), imageRef);</div><div class="line">    <span class="built_in">CGImageRef</span> inflatedImageRef = <span class="built_in">CGBitmapContextCreateImage</span>(context);</div><div class="line"></div><div class="line">    <span class="built_in">CGContextRelease</span>(context);</div><div class="line"></div><div class="line">    <span class="built_in">UIImage</span> *inflatedImage = [[<span class="built_in">UIImage</span> alloc] initWithCGImage:inflatedImageRef scale:scale orientation:image.imageOrientation];</div><div class="line"></div><div class="line">    <span class="built_in">CGImageRelease</span>(inflatedImageRef);</div><div class="line">    <span class="built_in">CGImageRelease</span>(imageRef);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> inflatedImage;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä½¿ç”¨<code>UIImage</code>çš„æ–¹æ³•ç›´æ¥åˆ›å»ºå›¾ç‰‡æ—¶ä¼šåœ¨å›¾ç‰‡éœ€è¦æ¸²æŸ“åˆ°å±å¹•ä¸Šæ—¶å†æ”¾åˆ°ä¸»çº¿ç¨‹ä¸Šè§£å‹ï¼Œå¦‚æœåœ¨ä¸»çº¿ç¨‹ä¸­éœ€è¦åŒæ—¶è§£å‹å¤šä¸ªå›¾ç‰‡å°†å¯èƒ½ä¼šå¯¼è‡´å¡é¡¿ã€‚è¿™æ—¶å€™å¦‚æœåœ¨æ¥æ”¶åˆ°å›¾ç‰‡æ—¶ï¼Œå…ˆåœ¨åå°çº¿ç¨‹ä¸­è¿›è¡Œè§£å‹æ˜¯æ¯”è¾ƒä¸é”™çš„ä¼˜åŒ–ã€‚å…³äºæ›´å¤šiOSå›¾ç‰‡è§£å‹å¤„ç†çš„çŸ¥è¯†å¯ä»¥åœ¨<a href="https://github.com/path/FastImageCache#how-fast-image-cache-works" target="_blank" rel="noopener">è¿™é‡Œ</a>äº†è§£ã€‚</p>
<h1 id="Securityæ¨¡å—"><a href="#Securityæ¨¡å—" class="headerlink" title="Securityæ¨¡å—"></a>Securityæ¨¡å—</h1><p>è™½ç„¶è‹¹æœç›®å‰å·²ç»è¦æ±‚åº”ç”¨éƒ½å¼€å¯ATSåŠŸèƒ½ï¼ˆApp Transport Securityï¼‰å¼ºåˆ¶ä½¿ç”¨HTTPSæ¥åšè¯·æ±‚ä»¥æ­¤åŠ å¼ºç½‘ç»œä¼ è¾“çš„å®‰å…¨ï¼Œä½†æ˜¯HTTPSä¹Ÿå¯èƒ½ä¼šé­å—<a href="https://www.zhihu.com/question/20744215" target="_blank" rel="noopener">ä¸­é—´äººæ”»å‡»</a>ï¼ˆä½¿ç”¨CharlesæŠ“åŒ…æ—¶å°±ç”¨åˆ°äº†è¿™ç§æŠ€æœ¯ï¼‰ï¼Œå¹¸è¿çš„æ˜¯åœ¨Client-Serveræ¶æ„ä¸­ï¼Œå¯ä»¥é€šè¿‡SSLç»‘å®šï¼ˆpinnigï¼‰æ¥è¿›ä¸€æ­¥åŠ å¼ºç½‘ç»œå®‰å…¨ä¼ è¾“ã€‚SSLç»‘å®šå³æ˜¯å°†è¯ä¹¦æ”¾åˆ°APPå†…ï¼Œåœ¨è¿›è¡Œç½‘ç»œè¯·æ±‚æ—¶ä½¿ç”¨APPå†…çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ã€‚æ¥ä¸‹æ¥çœ‹ä¸‹AFNetworkingæ˜¯æ€æ ·å®ç°çš„ã€‚</p>
<p><code>AFSecurityPolicy</code>ç±»çš„ä»‹ç»ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    AFSecurityPolicyä½¿ç”¨å›ºå®šçš„x.509è¯ä¹¦å’Œå®‰å…¨é“¾æ¥ä¸Šçš„å…¬é’¥æ¥è¯„ä¼°æœåŠ¡å™¨çš„å—ä¿¡ä»»ç¨‹åº¦ã€‚</span></div><div class="line"><span class="comment">    åœ¨ä½ çš„åº”ç”¨ä¸­æ·»åŠ ç»‘å®šçš„SSLè¯ä¹¦æœ‰åˆ©äºé˜²æ­¢â€œä¸­é—´äººæ”»å‡»â€å’Œå…¶ä»–ç¼ºé™·ã€‚</span></div><div class="line"><span class="comment">    åº”ç”¨åœ¨å¤„ç†æ•æ„Ÿçš„å®¢æˆ·æ•°æ®æˆ–è€…é‡‘èä¿¡æ¯æ—¶ï¼Œå¼ºçƒˆå»ºè®®åœ¨HTTPSçš„åŸºç¡€ä¸Šä½¿ç”¨SSLç»‘å®šçš„é…ç½®å’Œæˆæƒæ¥è¿›è¡Œç½‘ç»œé€šè®¯ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFSecurityPolicy</span> : <span class="title">NSObject</span> &lt;<span class="title">NSSecureCoding</span>, <span class="title">NSCopying</span>&gt;</span></div></pre></div></div></figure></p>
<p>ä¸€äº›ä¸»è¦çš„å±æ€§ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    è¯„ä¼°æœåŠ¡å™¨æ˜¯å¦å—ä¿¡ä»»çš„æ ‡å‡†ã€‚é»˜è®¤æ˜¯AFSSLPinningModeNone</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) AFSSLPinningMode SSLPinningMode;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    æ ¹æ®SSLPinningModeè¢«ç”¨äºè¯„ä¼°æœåŠ¡å™¨ä¿¡ä»»çš„è¯ä¹¦ã€‚</span></div><div class="line"><span class="comment">    åœ¨ä½ ä½¿ç”¨AFNetworkingä½œä¸ºåµŒå…¥frameworkæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå°†ä¼šæŠŠtargetçš„AFNetworking.frameworkå†…æ‰€æœ‰.cerè¯ä¹¦éƒ½æ·»åŠ åˆ°è¯¥å±æ€§å†…ï¼Œé»˜è®¤æ²¡æœ‰è¯ä¹¦ã€‚ä½¿ç”¨certificatesInBundleæ–¹æ³•ä»ä½ çš„targetä¸­åŠ è½½æ‰€æœ‰è¯ä¹¦ï¼Œå†ä½¿ç”¨policyWithPinningMode:withPinnedCertificatesåˆ›å»ºæ–°çš„policyã€‚</span></div><div class="line"><span class="comment">    æ³¨æ„ï¼Œå¦‚æœSSLPinningModeä¸ä¸ºAFSSLPinningModeNoneï¼Œåœ¨ç»‘å®šè¯ä¹¦åŒ¹é…çš„æƒ…å†µä¸‹ï¼ŒevaluateServerTrust:forDomain:å°†è¿”å›trueã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">NSSet</span> &lt;<span class="built_in">NSData</span> *&gt; *pinnedCertificates;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    æ˜¯å¦ä¿¡ä»»æ— æ•ˆçš„æˆ–è€…è¿‡æœŸçš„è¯ä¹¦ï¼Œåªåœ¨SSLPinningModeä¸ºAFSSLPinningModeNoneæœ‰æ•ˆã€‚é»˜è®¤ä¸ºNOã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> allowInvalidCertificates;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    æ˜¯å¦æ ¡éªŒæœåŠ¡å™¨åŸŸåã€‚é»˜è®¤ä¸ºYESã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> validatesDomainName;</div></pre></div></div></figure></p>
<p>éªŒè¯æœåŠ¡å™¨è¯ä¹¦çš„æ–¹æ³•ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    è¯„ä¼°æŒ‡å®šçš„æœåŠ¡å™¨ä¿¡ä»»ï¼ˆserver trustï¼‰åœ¨å½“å‰å®‰å…¨ç­–ç•¥ä¸‹æ˜¯å¦å¯è¢«ä¿¡ä»»ã€‚</span></div><div class="line"><span class="comment">    å½“æœåŠ¡å™¨è¿”å›ä¸€ä¸ªé‰´æƒæŸ¥è¯¢ï¼ˆauthentication challengeï¼‰æ—¶éœ€è¦ä½¿ç”¨è¯¥æ–¹æ³•ã€‚</span></div><div class="line"><span class="comment">    @param serverTrust æœåŠ¡å™¨ä¿¡ä»»çš„X.509è¯ä¹¦ã€‚</span></div><div class="line"><span class="comment">    @param domain åŸŸåã€‚</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">    @return æ˜¯å¦ä¿¡ä»»æœåŠ¡å™¨ã€‚</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="built_in">BOOL</span>)evaluateServerTrust:(SecTrustRef)serverTrust</div><div class="line">                  forDomain:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)domain;</div></pre></div></div></figure></p>
<p>æ ¡éªŒè¯ä¹¦éƒ½æ˜¯é€šè¿‡è°ƒç”¨ç³»ç»Ÿåº“<code>&lt;Security/Security.h&gt;</code>çš„æ–¹æ³•ã€‚<code>AFNetworking</code>æ‰€åšçš„æ“ä½œä¸»è¦æ˜¯æ ¹æ®è®¾ç½®çš„<code>AFSecurityPolicy</code>å¯¹è±¡çš„å±æ€§è¿›è¡Œè¯ä¹¦éªŒè¯ã€‚å½“<code>SSLPinningMode</code>ä¸è¿›è¡Œè®¾ç½®æˆ–è®¾ç½®ä¸º<code>AFSSLPinningModeNone</code>æ—¶ï¼Œå°†ä¸è¿›è¡ŒéªŒè¯ï¼Œè®¾ç½®ä¸º<code>AFSSLPinningModeCertificate</code>ä¼šä½¿ç”¨è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼Œè®¾ç½®ä¸º<code>AFSSLPinningModePublicKey</code>å°†ç›´æ¥ä½¿ç”¨è¯ä¹¦é‡Œé¢çš„å…¬é’¥è¿›è¡ŒéªŒè¯ã€‚å¯ä»¥é€šè¿‡è®¾ç½®<code>pinnedCertificates</code>å±æ€§æ¥è®¾ç½®éªŒè¯æ‰€ç”¨çš„è¯ä¹¦ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>+certificatesInBundle:</code>æ–¹æ³•åŠ è½½å•ç‹¬æ”¾åœ¨ä¸€ä¸ªBundleé‡Œçš„è¯ä¹¦ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œ<code>AFNetworking</code>ä¼šä½¿ç”¨<code>NSBundle</code>çš„<code>+bundleForClass:</code>æ–¹æ³•å°†æ”¾åœ¨<code>AFNetworking.framework</code>é‡Œé¢çš„ceræ–‡ä»¶ä½œä¸ºéªŒè¯æ‰€ç”¨è¯ä¹¦ã€‚å…·ä½“éªŒè¯ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></div><div class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>)evaluateServerTrust:(SecTrustRef)serverTrust</div><div class="line">                  forDomain:(<span class="built_in">NSString</span> *)domain</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (domain &amp;&amp; <span class="keyword">self</span>.allowInvalidCertificates &amp;&amp; <span class="keyword">self</span>.validatesDomainName &amp;&amp; (<span class="keyword">self</span>.SSLPinningMode == AFSSLPinningModeNone || [<span class="keyword">self</span>.pinnedCertificates count] == <span class="number">0</span>)) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"In order to validate a domain name for self signed certificates, you MUST use pinning."</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">NSMutableArray</span> *policies = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.validatesDomainName) &#123;</div><div class="line">        [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateSSL(<span class="literal">true</span>, (__bridge <span class="built_in">CFStringRef</span>)domain)];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateBasicX509()];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SecTrustSetPolicies(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)policies);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.SSLPinningMode == AFSSLPinningModeNone) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.allowInvalidCertificates || AFServerTrustIsValid(serverTrust);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!AFServerTrustIsValid(serverTrust) &amp;&amp; !<span class="keyword">self</span>.allowInvalidCertificates) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (<span class="keyword">self</span>.SSLPinningMode) &#123;</div><div class="line">        <span class="keyword">case</span> AFSSLPinningModeNone:</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">        <span class="keyword">case</span> AFSSLPinningModeCertificate: &#123;</div><div class="line">            <span class="built_in">NSMutableArray</span> *pinnedCertificates = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">            <span class="keyword">for</span> (<span class="built_in">NSData</span> *certificateData <span class="keyword">in</span> <span class="keyword">self</span>.pinnedCertificates) &#123;</div><div class="line">                [pinnedCertificates addObject:(__bridge_transfer <span class="keyword">id</span>)SecCertificateCreateWithData(<span class="literal">NULL</span>, (__bridge <span class="built_in">CFDataRef</span>)certificateData)];</div><div class="line">            &#125;</div><div class="line">            SecTrustSetAnchorCertificates(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)pinnedCertificates);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!AFServerTrustIsValid(serverTrust)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// obtain the chain after being validated, which *should* contain the pinned certificate in the last position (if it's the Root CA)</span></div><div class="line">            <span class="built_in">NSArray</span> *serverCertificates = AFCertificateTrustChainForServerTrust(serverTrust);</div><div class="line">            </div><div class="line">            <span class="keyword">for</span> (<span class="built_in">NSData</span> *trustChainCertificate <span class="keyword">in</span> [serverCertificates reverseObjectEnumerator]) &#123;</div><div class="line">                <span class="keyword">if</span> ([<span class="keyword">self</span>.pinnedCertificates containsObject:trustChainCertificate]) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> AFSSLPinningModePublicKey: &#123;</div><div class="line">            <span class="built_in">NSUInteger</span> trustedPublicKeyCount = <span class="number">0</span>;</div><div class="line">            <span class="built_in">NSArray</span> *publicKeys = AFPublicKeyTrustChainForServerTrust(serverTrust);</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">id</span> trustChainPublicKey <span class="keyword">in</span> publicKeys) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">id</span> pinnedPublicKey <span class="keyword">in</span> <span class="keyword">self</span>.pinnedPublicKeys) &#123;</div><div class="line">                    <span class="keyword">if</span> (AFSecKeyIsEqualToKey((__bridge SecKeyRef)trustChainPublicKey, (__bridge SecKeyRef)pinnedPublicKey)) &#123;</div><div class="line">                        trustedPublicKeyCount += <span class="number">1</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> trustedPublicKeyCount &gt; <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨AFSecurityPolicy.mæ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†ç±»ä¼¼<code>__Require_Quiet</code>çš„å®æ¥é€šè¿‡gotoè¯­å¥æ¥ä¼˜é›…åœ°å¤ç”¨_outå—é‡Œé¢çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></div><div class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">id</span> AFPublicKeyForCertificate(<span class="built_in">NSData</span> *certificate) &#123;</div><div class="line">    <span class="keyword">id</span> allowedPublicKey = <span class="literal">nil</span>;</div><div class="line">    SecCertificateRef allowedCertificate;</div><div class="line">    SecPolicyRef policy = <span class="literal">nil</span>;</div><div class="line">    SecTrustRef allowedTrust = <span class="literal">nil</span>;</div><div class="line">    SecTrustResultType result;</div><div class="line"></div><div class="line">    allowedCertificate = SecCertificateCreateWithData(<span class="literal">NULL</span>, (__bridge <span class="built_in">CFDataRef</span>)certificate);</div><div class="line">    __Require_Quiet(allowedCertificate != <span class="literal">NULL</span>, _<span class="keyword">out</span>);</div><div class="line"></div><div class="line">    policy = SecPolicyCreateBasicX509();</div><div class="line">    __Require_noErr_Quiet(SecTrustCreateWithCertificates(allowedCertificate, policy, &amp;allowedTrust), _<span class="keyword">out</span>);</div><div class="line">    __Require_noErr_Quiet(SecTrustEvaluate(allowedTrust, &amp;result), _<span class="keyword">out</span>);</div><div class="line"></div><div class="line">    allowedPublicKey = (__bridge_transfer <span class="keyword">id</span>)SecTrustCopyPublicKey(allowedTrust);</div><div class="line"></div><div class="line">_<span class="keyword">out</span>:</div><div class="line">    <span class="keyword">if</span> (allowedTrust) &#123;</div><div class="line">        <span class="built_in">CFRelease</span>(allowedTrust);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (policy) &#123;</div><div class="line">        <span class="built_in">CFRelease</span>(policy);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (allowedCertificate) &#123;</div><div class="line">        <span class="built_in">CFRelease</span>(allowedCertificate);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> allowedPublicKey;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<h1 id="Reachabilityæ¨¡å—"><a href="#Reachabilityæ¨¡å—" class="headerlink" title="Reachabilityæ¨¡å—"></a>Reachabilityæ¨¡å—</h1><p><strong>AFNetworkReachabilityManagerç±»çš„è¯´æ˜</strong><br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    AFNetworkReachabilityManagerç”¨äºç›‘å¬åŸŸåæˆ–è€…IPåœ°å€çš„å¯è¾¾æ€§ï¼ŒåŒ…æ‹¬WWANå’ŒWiFiç½‘ç»œæ¥å£ã€‚</span></div><div class="line"><span class="comment">    Reachabilityå¯ä»¥è¢«ç”¨æ¥ç¡®å®šä¸€ä¸ªç½‘ç»œæ“ä½œå¤±è´¥çš„åå°ä¿¡æ¯ï¼Œæˆ–è€…å½“è¿æ¥å»ºç«‹æ—¶è§¦å‘ç½‘ç»œæ“ä½œé‡è¯•ã€‚</span></div><div class="line"><span class="comment">    å®ƒä¸åº”è¯¥ç”¨äºé˜»æ­¢ç”¨æˆ·å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œå› ä¸ºå¯èƒ½éœ€è¦ç¬¬ä¸€ä¸ªè¯·æ±‚æ¥å»ºç«‹å¯è¾¾æ€§ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFNetworkReachabilityManager</span> : <span class="title">NSObject</span></span></div></pre></div></div></figure></p>
<p><code>AFNetworkReachabilityManager</code>ä¸»è¦é€šè¿‡ç³»ç»Ÿåº“çš„æ–¹æ³•æ¥å®ç°ç½‘ç»œç›‘å¬,å¹¶ä»¥Blockçš„æ–¹å¼è¿›è¡Œå›è°ƒï¼Œä¸»è¦å®ç°çš„ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></div><div class="code"><pre><div class="line">- (<span class="keyword">void</span>)startMonitoring &#123;</div><div class="line">    [<span class="keyword">self</span> stopMonitoring];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.networkReachability) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    __<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)weakSelf = <span class="keyword">self</span>;</div><div class="line">    AFNetworkReachabilityStatusBlock callback = ^(AFNetworkReachabilityStatus status) &#123;</div><div class="line">        __<span class="keyword">strong</span> __<span class="keyword">typeof</span>(weakSelf)strongSelf = weakSelf;</div><div class="line"></div><div class="line">        strongSelf.networkReachabilityStatus = status;</div><div class="line">        <span class="keyword">if</span> (strongSelf.networkReachabilityStatusBlock) &#123;</div><div class="line">            strongSelf.networkReachabilityStatusBlock(status);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="built_in">SCNetworkReachabilityContext</span> context = &#123;<span class="number">0</span>, (__bridge <span class="keyword">void</span> *)callback, AFNetworkReachabilityRetainCallback, AFNetworkReachabilityReleaseCallback, <span class="literal">NULL</span>&#125;;</div><div class="line">    <span class="built_in">SCNetworkReachabilitySetCallback</span>(<span class="keyword">self</span>.networkReachability, AFNetworkReachabilityCallback, &amp;context);</div><div class="line">    <span class="built_in">SCNetworkReachabilityScheduleWithRunLoop</span>(<span class="keyword">self</span>.networkReachability, <span class="built_in">CFRunLoopGetMain</span>(), kCFRunLoopCommonModes);</div><div class="line"></div><div class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, <span class="number">0</span>),^&#123;</div><div class="line">        <span class="built_in">SCNetworkReachabilityFlags</span> flags;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">SCNetworkReachabilityGetFlags</span>(<span class="keyword">self</span>.networkReachability, &amp;flags)) &#123;</div><div class="line">            AFPostReachabilityStatusChange(flags, callback);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>ä¸Šé¢ä»£ç ä¸­ä½¿ç”¨æ–°å»ºçš„callbackè€Œä¸æ˜¯ä½¿ç”¨<code>networkReachabilityStatusBlock</code>å±æ€§æ˜¯ä¸ºäº†å°†è°ƒç”¨<code>-startMonitoring</code>å’Œ<code>-setReachabilityStatusChangeBlock</code>åˆ†å¼€ï¼Œåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥éšæ—¶é‡æ–°è®¾ç½®å›è°ƒè€Œä¸ä¼šå—åˆ°å½±å“ã€‚<br>è¿˜æœ‰å¦å¤–å…³é”®çš„ä¸€ç‚¹ï¼Œ<code>AFNetworking</code>ä½¿ç”¨<code>__strong __typeof(weakSelf)strongSelf = weakSelf;</code>åœ¨blockä¸­é‡æ–°æŒæœ‰äº†å¯¹è±¡ï¼Œè¿™æ ·åšçš„åŸå› æ˜¯æ—¢å¯ä»¥ä¿è¯åœ¨blockèŒƒå›´å†…å¯¹è±¡å§‹ç»ˆå­˜åœ¨ï¼Œåˆä¸ä¼šå¼•èµ·å¾ªç¯å¼•ç”¨ã€‚å› ä¸ºstrongSelfçš„ä½œç”¨åŸŸåªåœ¨æœ¬blockå†…ï¼Œå¯¹è±¡ä¹Ÿä¸ç›´æ¥æŒæœ‰è¯¥blockï¼Œæ‰€ä»¥å½“blockè¢«é‡Šæ”¾æ—¶ï¼ŒstrongSelfä¹Ÿä¼šè¢«é‡Šæ”¾ã€‚</p>
<h1 id="NSURLSessionæ¨¡å—"><a href="#NSURLSessionæ¨¡å—" class="headerlink" title="NSURLSessionæ¨¡å—"></a>NSURLSessionæ¨¡å—</h1><p><code>NSURLSession</code>æ˜¯ç”¨äºå¤„ç†HTTPè¯·æ±‚çš„ç±»ï¼Œé€šè¿‡ä¸€ä¸ª<code>NSURLSessionConfiguration</code>å¯¹è±¡é…ç½®å¤„ç†Cacheã€Cookiesã€Credibilityçš„æ–¹å¼ï¼Œå¹¶é€šè¿‡ä¸€ç³»åˆ—åè®®æ¥å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œç»“æ„å¦‚ä¸‹ï¼š<br><img src="/images/NSURLSession_structure.jpg" alt="NSURLSessionç»“æ„å›¾"><br><code>NSURLSession</code>å¯ä»¥æ ¹æ®é…ç½®åˆ›å»ºä¸€ä¸ªä¸ª<code>NSURLSessionTask</code>å¯¹è±¡æ¥å®Œæˆæ¯ä¸€æ¬¡HTTPè¯·æ±‚ä»»åŠ¡ï¼Œ<code>NSURLSessionTask</code>å°±æ˜¯ä¸€æ¬¡HTTPè¯·æ±‚å’Œå“åº”çš„äº¤äº’è¿‡ç¨‹çš„å°è£…ã€‚<br><img src="/images/NSURLSession_create_tasks.png" alt="NSURLSessionåˆ›å»ºtasks"></p>
<h2 id="AFURLSessionManager"><a href="#AFURLSessionManager" class="headerlink" title="AFURLSessionManager"></a>AFURLSessionManager</h2><p><code>AFNetworking</code>é€šè¿‡<code>AFURLSessionManager</code>æ¥å¯¹<code>NSURLSession</code>è¿›è¡Œå°è£…ç®¡ç†ã€‚<code>AFURLSessionManager</code>ç®€åŒ–äº†ç”¨æˆ·ç½‘ç»œè¯·æ±‚çš„æ“ä½œï¼Œä½¿å¾—ç”¨æˆ·åªéœ€ä»¥blockçš„æ–¹å¼æ¥æ›´ç®€ä¾¿åœ°è¿›è¡Œç½‘ç»œè¯·æ±‚æ“ä½œï¼Œè€Œæ— éœ€å®ç°ç±»ä¼¼<code>NSURLSessionDelegate</code>ã€<code>NSURLSessionTaskDelegate</code>ç­‰åè®®ã€‚ç”¨æˆ·åªéœ€ä½¿ç”¨åˆ°<code>NSURLSessionTask</code>çš„<code>-resume</code>ã€<code>-cancel</code>å’Œ<code>-suspned</code>ç­‰æ“ä½œï¼Œä»¥åŠåœ¨blockä¸­å®šä¹‰ä½ éœ€è¦çš„æ“ä½œå°±å¯ä»¥ã€‚<br><strong>AFURLSessionManager.h</strong><br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    AFURLSessionManageråˆ›å»ºå¹¶ç®¡ç†ä¸€ä¸ªåŸºäºNSURLSessionConfigurationå¯¹è±¡çš„å¯¹è±¡ï¼Œå¹¶ä¸”éµå®ˆäº†&lt;NSURLSessionTaskDelegate&gt;ã€&lt;NSURLSessionDataDelegate&gt;ã€&lt;NSURLSessionDownloadDelegate&gt;ä»¥åŠ&lt;NSURLSessionDelegate&gt;åè®®ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFURLSessionManager</span> : <span class="title">NSObject</span> &lt;<span class="title">NSURLSessionDelegate</span>, <span class="title">NSURLSessionTaskDelegate</span>, <span class="title">NSURLSessionDataDelegate</span>, <span class="title">NSURLSessionDownloadDelegate</span>, <span class="title">NSSecureCoding</span>, <span class="title">NSCopying</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//å±æ€§</span></div><div class="line"><span class="comment">/** ç®¡ç†çš„session */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSURLSession</span> *session;</div><div class="line"><span class="comment">/** ä»£ç†å›è°ƒä¸­åœ¨è¿è¡Œçš„operationQueueã€‚ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSOperationQueue</span> *operationQueue;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    ä½¿ç”¨æ–¹æ³•dataTaskWithRequest:success:failure:å¹¶ä¸”ä½¿ç”¨äº†GETã€POSTç­‰ç®€ä¾¿æ–¹æ³•çš„è¿”å›çš„æ•°æ®å°†è¢«è‡ªåŠ¨ä½¿ç”¨responseSerializeræ£€éªŒå’Œåºåˆ—åŒ–ã€‚é»˜è®¤ä¸ºä¸€ä¸ªAFJSONResponseSerializerå¯¹è±¡ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> &lt;AFURLResponseSerialization&gt; responseSerializer;</div><div class="line"><span class="comment">/** ç”¨äºè¯„ä¼°æœåŠ¡å™¨å—ä¿¡ä»»æƒ…å†µçš„å®‰å…¨ç­–ç•¥ã€‚é»˜è®¤ä½¿ç”¨defaultPolicyã€‚ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFSecurityPolicy *securityPolicy;</div><div class="line"><span class="comment">/** ç½‘ç»œç›‘æµ‹ç®¡ç†å¯¹è±¡ã€‚é»˜è®¤sharedManagerã€‚ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFNetworkReachabilityManager *reachabilityManager;</div><div class="line"><span class="comment">/** å½“å‰è¿è¡Œåœ¨sessionä¸­çš„æ‰€æœ‰æ•°æ®ã€ä¸Šä¼ å’Œä¸‹è½½ä»»åŠ¡ã€‚ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSURLSessionTask</span> *&gt; *tasks;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSURLSessionDataTask</span> *&gt; *dataTasks;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSURLSessionUploadTask</span> *&gt; *uploadTasks;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSURLSessionDownloadTask</span> *&gt; *downloadTasks;</div><div class="line"><span class="comment">/** æ‰§è¡ŒcompletionBlockçš„é˜Ÿåˆ—ã€‚é»˜è®¤ä¸ºä¸»çº¿ç¨‹é˜Ÿåˆ—ã€‚ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">dispatch_queue_t</span> completionQueue;</div><div class="line"><span class="comment">/** æ‰§è¡ŒcompletionBlockçš„groupã€‚é»˜è®¤ä¸ºä¸€ä¸ªç§æœ‰çš„dispatch_groupã€‚ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) dispatch_group_t completionGroup;</div><div class="line"></div><div class="line"><span class="comment">//æ–¹æ³•</span></div><div class="line"><span class="comment">/** æ ¹æ®æŒ‡å®šçš„é…ç½®åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªNSURLSessionã€‚ */</span></div><div class="line">- (<span class="keyword">instancetype</span>)initWithSessionConfiguration:(<span class="keyword">nullable</span> <span class="built_in">NSURLSessionConfiguration</span> *)configuration <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</div><div class="line"><span class="comment">/** ä¸€ç³»åˆ—ç±»ä¼¼ä»¥ä¸‹çš„åˆ›å»ºNSURLSessionTaskçš„æ–¹æ³•ã€‚ */</span></div><div class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</div><div class="line">                            completionHandler:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> _Nullable responseObject,  <span class="built_in">NSError</span> * _Nullable error))completionHandler DEPRECATED_ATTRIBUTE;</div><div class="line"><span class="comment">/** ä¸€ç³»åˆ—ç±»ä¼¼ä»¥ä¸‹è®¾ç½®å›è°ƒçš„æ–¹æ³•ã€‚ */</span></div><div class="line">- (<span class="keyword">void</span>)setSessionDidBecomeInvalidBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSError</span> *error))block;</div></pre></div></div></figure></p>
<p><code>AFURLSessionManager</code>å°†æ¯ä¸€ä¸ªtaskéƒ½åˆ†åˆ«äº¤ç»™ä¸€ä¸ª<code>AFURLSessionManagerTaskDelegate</code>å¯¹è±¡è¿›è¡Œç®¡ç†ï¼Œ<code>AFURLSessionManagerTaskDelegate</code>ç›¸å½“äºæ‰©å±•äº†<code>NSURLSessionTask</code>çš„å±æ€§ã€‚<br><strong>NSURLSessionTaskå±æ€§</strong><br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></div><div class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFURLSessionManagerTaskDelegate</span> : <span class="title">NSObject</span> &lt;<span class="title">NSURLSessionTaskDelegate</span>, <span class="title">NSURLSessionDataDelegate</span>, <span class="title">NSURLSessionDownloadDelegate</span>&gt;</span></div><div class="line">- (<span class="keyword">instancetype</span>)initWithTask:(<span class="built_in">NSURLSessionTask</span> *)task;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) AFURLSessionManager *manager;</div><div class="line"><span class="comment">/** æœåŠ¡å™¨è¿”å›å“åº”çš„æ•°æ® */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableData</span> *mutableData;</div><div class="line"><span class="comment">/** ä¸Šä¼ å’Œä¸‹è½½è¿›åº¦æ¡ */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSProgress</span> *uploadProgress;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSProgress</span> *downloadProgress;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSURL</span> *downloadFileURL;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDownloadTaskDidFinishDownloadingBlock downloadTaskDidFinishDownloading;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskProgressBlock uploadProgressBlock;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskProgressBlock downloadProgressBlock;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskCompletionHandler completionHandler;</div><div class="line"><span class="keyword">@end</span></div></pre></div></div></figure></p>
<p><code>AFURLSessionManagerTaskDelegate</code>é€šè¿‡å®ç°<code>NSURLSessionTaskDelegate</code>ã€<code>NSURLSessionDataDelegate</code>å’Œ<code>NSURLSessionDownloadDelegate</code>åè®®çš„ç›¸å…³æ–¹æ³•æ¥ç›‘å¬ç½‘ç»œè¯·æ±‚çš„å®Œæ•´è¿‡ç¨‹ï¼Œå¹¶æ“ä½œå®ƒçš„å±æ€§å€¼mutableDataã€uploadProgressç­‰ï¼Œå¹¶åœ¨å¯¹åº”æ—¶åˆ»å›è°ƒblockã€‚<br>ä»¥ä¸€ä¸ªä¸‹è½½ä»»åŠ¡ä¸ºä¾‹ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"><span class="comment">    ç›‘å¬NSProgressçš„fractionCompletedå±æ€§ï¼ŒfractionCompletedè®°å½•ç€è¿›åº¦æ¡çš„å®Œæˆæ¯”ä¾‹ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line">[progress addObserver:<span class="keyword">self</span></div><div class="line">                   forKeyPath:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(fractionCompleted))</div><div class="line">                      options:<span class="built_in">NSKeyValueObservingOptionNew</span></div><div class="line">                      context:<span class="literal">NULL</span>];</div><div class="line">---------------------------------------------------</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    å½“fractionCompletedå‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œå›è°ƒã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</div><div class="line">   <span class="keyword">if</span> ([object isEqual:<span class="keyword">self</span>.downloadProgress]) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.downloadProgressBlock) &#123;</div><div class="line">            <span class="keyword">self</span>.downloadProgressBlock(object);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([object isEqual:<span class="keyword">self</span>.uploadProgress]) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.uploadProgressBlock) &#123;</div><div class="line">            <span class="keyword">self</span>.uploadProgressBlock(object);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">---------------------------------------------------</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    ç›‘å¬NSURLSessionDownloadTaskçš„è¿›åº¦ï¼Œä¿®æ”¹NSProgressçš„totalUnitCountå’ŒcompletedUnitCountè¿›è€Œå½±å“fractionCompletedå±æ€§ã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</div><div class="line">      didWriteData:(int64_t)bytesWritten</div><div class="line"> totalBytesWritten:(int64_t)totalBytesWritten</div><div class="line">totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.downloadProgress.totalUnitCount = totalBytesExpectedToWrite;</div><div class="line">    <span class="keyword">self</span>.downloadProgress.completedUnitCount = totalBytesWritten;</div><div class="line">&#125;</div><div class="line">---------------------------------------------------</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    ä¸‹è½½å®Œæˆåï¼Œå°†æ–‡ä»¶ä¿å­˜åœ¨downloadTaskDidFinishDownloadingè¿”å›çš„URLã€‚</span></div><div class="line"><span class="comment">*/</span></div><div class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</div><div class="line">      downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</div><div class="line">didFinishDownloadingToURL:(<span class="built_in">NSURL</span> *)location</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span>.downloadFileURL = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.downloadTaskDidFinishDownloading) &#123;</div><div class="line">        <span class="keyword">self</span>.downloadFileURL = <span class="keyword">self</span>.downloadTaskDidFinishDownloading(session, downloadTask, location);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</div><div class="line">            <span class="built_in">NSError</span> *fileManagerError = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (![[<span class="built_in">NSFileManager</span> defaultManager] moveItemAtURL:location toURL:<span class="keyword">self</span>.downloadFileURL error:&amp;fileManagerError]) &#123;</div><div class="line">                [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFURLSessionDownloadTaskDidFailToMoveFileNotification object:downloadTask userInfo:fileManagerError.userInfo];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>ä¸ºäº†åœ¨ä»»åŠ¡çš„æš‚åœå’Œæ¢å¤æ—¶å‘é€é€šçŸ¥ï¼Œ<code>AFNetworking</code>ä½¿ç”¨äº†åŠ¨æ€swizzlingä¿®æ”¹äº†ç³»ç»Ÿçš„<code>-resume</code>å’Œ<code>-suspend</code>æ–¹æ³•çš„IMPï¼Œå½“è°ƒç”¨<code>-resume</code>æ—¶å‘é€é€šçŸ¥ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/* éå†NSURLSessionDataTaskç±»åŠå…¶çˆ¶ç±»çš„resumeå’Œsuspendæ–¹æ³• */</span></div><div class="line"><span class="built_in">NSURLSessionDataTask</span> *localDataTask = [session dataTaskWithURL:<span class="literal">nil</span>];</div><div class="line">IMP originalAFResumeIMP = method_getImplementation(class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(af_resume)));</div><div class="line">Class currentClass = [localDataTask <span class="keyword">class</span>];</div><div class="line">        </div><div class="line"><span class="keyword">while</span> (class_getInstanceMethod(currentClass, <span class="keyword">@selector</span>(resume))) &#123;</div><div class="line">    Class superClass = [currentClass superclass];</div><div class="line">    IMP classResumeIMP = method_getImplementation(class_getInstanceMethod(currentClass, <span class="keyword">@selector</span>(resume)));</div><div class="line">    IMP superclassResumeIMP = method_getImplementation(class_getInstanceMethod(superClass, <span class="keyword">@selector</span>(resume)));</div><div class="line">    <span class="keyword">if</span> (classResumeIMP != superclassResumeIMP &amp;&amp;</div><div class="line">        originalAFResumeIMP != classResumeIMP) &#123;</div><div class="line">        [<span class="keyword">self</span> swizzleResumeAndSuspendMethodForClass:currentClass];</div><div class="line">    &#125;</div><div class="line">    currentClass = [currentClass superclass];</div><div class="line">&#125;</div><div class="line"><span class="comment">/* äº¤æ¢IMP */</span></div><div class="line">+ (<span class="keyword">void</span>)swizzleResumeAndSuspendMethodForClass:(Class)theClass &#123;</div><div class="line">    Method afResumeMethod = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(af_resume));</div><div class="line">    Method afSuspendMethod = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(af_suspend));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (af_addMethod(theClass, <span class="keyword">@selector</span>(af_resume), afResumeMethod)) &#123;</div><div class="line">        af_swizzleSelector(theClass, <span class="keyword">@selector</span>(resume), <span class="keyword">@selector</span>(af_resume));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (af_addMethod(theClass, <span class="keyword">@selector</span>(af_suspend), afSuspendMethod)) &#123;</div><div class="line">        af_swizzleSelector(theClass, <span class="keyword">@selector</span>(suspend), <span class="keyword">@selector</span>(af_suspend));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p><code>AFURLSessionManager</code>é€šè¿‡ä¸€ä¸ªå­—å…¸<code>mutableTaskDelegatesKeyedByTaskIdentifier</code>æ¥ä¿å­˜ç”¨æˆ·åˆ›å»ºçš„taskå’Œå…¶å¯¹åº”çš„<code>AFURLSessionManagerTaskDelegate</code>å¯¹è±¡ï¼Œå› ä¸º<code>NSMutableDictionary</code>å¯¹è±¡ä¼šå°†å…¶keyå€¼è¿›è¡Œcopyå’Œå¯¹å…¶valueå€¼è¿›è¡Œå¼ºå¼•ç”¨ï¼Œæ‰€ä»¥æ— éœ€å†æŒæœ‰taskå’Œdelegateã€‚<code>AFURLSessionManager</code>å·¥ä½œæµç¨‹æ˜¯ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªtaskå’Œä¸€ä¸ªdelegateæ¥ç®¡ç†taskï¼Œå¹¶å°†å®ƒä»¬ä¿å­˜åˆ°å­—å…¸é‡Œ</li>
<li>å®ç°<code>NSURLSessionDelegate</code>ç­‰åè®®çš„æ–¹æ³•ï¼Œç›‘å¬ä»»åŠ¡çŠ¶æ€ï¼Œé€šè¿‡blockå›è°ƒ</li>
<li>å½“ä»»åŠ¡å®Œæˆæ—¶ï¼Œç§»é™¤taskå’Œdelegate</li>
</ol>
<p>ä»¥ä¸‹è½½ä»»åŠ¡ä¸ºä¾‹ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></div><div class="code"><pre><div class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</div><div class="line">                                             progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</div><div class="line">                                          destination:(<span class="built_in">NSURL</span> * (^)(<span class="built_in">NSURL</span> *targetPath, <span class="built_in">NSURLResponse</span> *response))destination</div><div class="line">                                    completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURL</span> *filePath, <span class="built_in">NSError</span> *error))completionHandler</div><div class="line">&#123;</div><div class="line">    __block <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask = <span class="literal">nil</span>;</div><div class="line">    <span class="comment">/* åœ¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—åˆ›å»ºtask */</span></div><div class="line">    url_session_manager_create_task_safely(^&#123;</div><div class="line">        downloadTask = [<span class="keyword">self</span>.session downloadTaskWithRequest:request];</div><div class="line">    &#125;);</div><div class="line">     <span class="comment">/* åˆ›å»ºdelegateç®¡ç†taskå¹¶å°†å®ƒä»¬åŠ å…¥å­—å…¸ */</span></div><div class="line">    [<span class="keyword">self</span> addDelegateForDownloadTask:downloadTask progress:downloadProgressBlock destination:destination completionHandler:completionHandler];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> downloadTask;</div><div class="line">&#125;</div><div class="line">---------------------------------------------------</div><div class="line"><span class="comment">/* åˆ›å»ºdelegateç®¡ç†taskå¹¶å°†å®ƒä»¬åŠ å…¥å­—å…¸ */</span></div><div class="line">- (<span class="keyword">void</span>)addDelegateForDownloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</div><div class="line">                          progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</div><div class="line">                       destination:(<span class="built_in">NSURL</span> * (^)(<span class="built_in">NSURL</span> *targetPath, <span class="built_in">NSURLResponse</span> *response))destination</div><div class="line">                 completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURL</span> *filePath, <span class="built_in">NSError</span> *error))completionHandler</div><div class="line">&#123;</div><div class="line">    AFURLSessionManagerTaskDelegate *delegate = [[AFURLSessionManagerTaskDelegate alloc] initWithTask:downloadTask];</div><div class="line">    delegate.manager = <span class="keyword">self</span>;</div><div class="line">    delegate.completionHandler = completionHandler;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (destination) &#123;</div><div class="line">        delegate.downloadTaskDidFinishDownloading = ^<span class="built_in">NSURL</span> * (<span class="built_in">NSURLSession</span> * __unused session, <span class="built_in">NSURLSessionDownloadTask</span> *task, <span class="built_in">NSURL</span> *location) &#123;</div><div class="line">            <span class="keyword">return</span> destination(location, task.response);</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    downloadTask.taskDescription = <span class="keyword">self</span>.taskDescriptionForSessionTasks;</div><div class="line">     <span class="comment">/* åŠ å…¥å­—å…¸ */</span></div><div class="line">    [<span class="keyword">self</span> setDelegate:delegate forTask:downloadTask];</div><div class="line"></div><div class="line">    delegate.downloadProgressBlock = downloadProgressBlock;</div><div class="line">&#125;</div><div class="line">---------------------------------------------------</div><div class="line"><span class="comment">/* å­—å…¸ä¿å­˜taskå’Œdelegateï¼Œä½¿ç”¨é”ä¿è¯çº¿ç¨‹å®‰å…¨ */</span></div><div class="line">- (<span class="keyword">void</span>)setDelegate:(AFURLSessionManagerTaskDelegate *)delegate</div><div class="line">            forTask:(<span class="built_in">NSURLSessionTask</span> *)task</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSParameterAssert</span>(task);</div><div class="line">    <span class="built_in">NSParameterAssert</span>(delegate);</div><div class="line"></div><div class="line">    [<span class="keyword">self</span>.lock lock];</div><div class="line">    <span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)] = delegate;</div><div class="line">    [<span class="keyword">self</span> addNotificationObserverForTask:task];</div><div class="line">    [<span class="keyword">self</span>.lock unlock];</div><div class="line">&#125;</div><div class="line">---------------------------------------------------</div><div class="line"><span class="comment">/* ä»»åŠ¡å®Œæˆåç§»é™¤å‡ºå­—å…¸ */</span></div><div class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</div><div class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</div><div class="line">didCompleteWithError:(<span class="built_in">NSError</span> *)error</div><div class="line">&#123;</div><div class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:task];</div><div class="line"></div><div class="line">    <span class="comment">// delegate may be nil when completing a task in the background</span></div><div class="line">    <span class="keyword">if</span> (delegate) &#123;</div><div class="line">        [delegate URLSession:session task:task didCompleteWithError:error];</div><div class="line">          </div><div class="line">        [<span class="keyword">self</span> removeDelegateForTask:task];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.taskDidComplete) &#123;</div><div class="line">        <span class="keyword">self</span>.taskDidComplete(session, task, error);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>ä¸€äº›å…¶ä»–å€¼å¾—æ³¨æ„çš„ä»£ç ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></div><div class="code"><pre><div class="line"><span class="comment">/* æœåŠ¡å™¨è¿”å›é‰´æƒæŸ¥è¯¢ï¼ˆauthentication challengeï¼‰æ—¶ï¼Œä½¿ç”¨securityPolicyè¿›è¡Œä¿¡ä»»è¯„ä¼° */</span></div><div class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</div><div class="line">didReceiveChallenge:(<span class="built_in">NSURLAuthenticationChallenge</span> *)challenge</div><div class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition, <span class="built_in">NSURLCredential</span> *credential))completionHandler</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</div><div class="line">    __block <span class="built_in">NSURLCredential</span> *credential = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.sessionDidReceiveAuthenticationChallenge) &#123;</div><div class="line">        disposition = <span class="keyword">self</span>.sessionDidReceiveAuthenticationChallenge(session, challenge, &amp;credential);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> ([challenge.protectionSpace.authenticationMethod isEqualToString:<span class="built_in">NSURLAuthenticationMethodServerTrust</span>]) &#123;</div><div class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span>.securityPolicy evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:challenge.protectionSpace.host]) &#123;</div><div class="line">                credential = [<span class="built_in">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust];</div><div class="line">                <span class="keyword">if</span> (credential) &#123;</div><div class="line">                    disposition = <span class="built_in">NSURLSessionAuthChallengeUseCredential</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                disposition = <span class="built_in">NSURLSessionAuthChallengeCancelAuthenticationChallenge</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (completionHandler) &#123;</div><div class="line">        completionHandler(disposition, credential);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/* é€šè¿‡ä¿¡å·é‡å®ç°æ•°æ®çš„åŒæ­¥è¿”å› */</span></div><div class="line">- (<span class="built_in">NSArray</span> *)tasksForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</div><div class="line">    __block <span class="built_in">NSArray</span> *tasks = <span class="literal">nil</span>;</div><div class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</div><div class="line">    [<span class="keyword">self</span>.session getTasksWithCompletionHandler:^(<span class="built_in">NSArray</span> *dataTasks, <span class="built_in">NSArray</span> *uploadTasks, <span class="built_in">NSArray</span> *downloadTasks) &#123;</div><div class="line">        <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(dataTasks))]) &#123;</div><div class="line">            tasks = dataTasks;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(uploadTasks))]) &#123;</div><div class="line">            tasks = uploadTasks;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(downloadTasks))]) &#123;</div><div class="line">            tasks = downloadTasks;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(tasks))]) &#123;</div><div class="line">            tasks = [@[dataTasks, uploadTasks, downloadTasks] valueForKeyPath:<span class="string">@"@unionOfArrays.self"</span>];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        dispatch_semaphore_signal(semaphore);</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> tasks;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<h2 id="AFHTTPSessionManager"><a href="#AFHTTPSessionManager" class="headerlink" title="AFHTTPSessionManager"></a>AFHTTPSessionManager</h2><p><code>AFHTTPSessionManager</code>æ˜¯<code>AFURLSessionManager</code>çš„å­ç±»ï¼Œå®ƒçš„ä¸»è¦æ˜¯æ ¹æ®HTTPçš„è¯·æ±‚æ–¹å¼getã€postã€headã€deleteè¿›è¡Œè¿›ä¸€æ­¥çš„å°è£…ä»¥ä¾¿æˆ‘ä»¬æ›´æ–¹ä¾¿åœ°ä½¿ç”¨ã€‚ä»¥POSTè¯·æ±‚æ–¹å¼ä¸ºä¾‹ï¼Œçœ‹ä¸‹<code>AFHTTPSessionManager</code>å¦‚ä½•è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼š<br><figure class="highlight objc"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></div><div class="code"><pre><div class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)POST:(<span class="built_in">NSString</span> *)URLString</div><div class="line">                    parameters:(<span class="keyword">id</span>)parameters</div><div class="line">                      progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> * _Nonnull))uploadProgress</div><div class="line">                       success:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> * _Nonnull, <span class="keyword">id</span> _Nullable))success</div><div class="line">                       failure:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> * _Nullable, <span class="built_in">NSError</span> * _Nonnull))failure</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSURLSessionDataTask</span> *dataTask = [<span class="keyword">self</span> dataTaskWithHTTPMethod:<span class="string">@"POST"</span> URLString:URLString parameters:parameters uploadProgress:uploadProgress downloadProgress:<span class="literal">nil</span> success:success failure:failure];</div><div class="line"></div><div class="line">    [dataTask resume];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> dataTask;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://segmentfault.com/a/1190000005833523" target="_blank" rel="noopener">https://segmentfault.com/a/1190000005833523</a><br><a href="https://www.raywenderlich.com/158106/urlsession-tutorial-getting-started" target="_blank" rel="noopener">https://www.raywenderlich.com/158106/urlsession-tutorial-getting-started</a><br><a href="https://developer.apple.com/documentation/foundation/nsurlsession?language=occ" target="_blank" rel="noopener">https://developer.apple.com/documentation/foundation/nsurlsession?language=occ</a><br><a href="https://developer.apple.com/documentation/foundation/url_loading_system?language=objc" target="_blank" rel="noopener">https://developer.apple.com/documentation/foundation/url_loading_system?language=objc</a></p>

      
    </div>
    
    
    

    

     
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š</strong>
    è®¸æ¡‚æ–Œ
  </li>
  <li class="post-copyright-link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://xxxxxxgb.github.io/2018/05/02/AFNetworking/" title="è¯»ä¸€è¯»AFNetworking3">https://xxxxxxgb.github.io/2018/05/02/AFNetworking/</a>
  </li>
  <li class="post-copyright-license">
    <strong>æ¸©é¦¨æç¤ºï¼š </strong>
    <span class="tip">ç”±äºæ˜¯åŸåˆ›æ–‡ç« ï¼Œå¯èƒ½ä¼šæœ‰æ›´æ–°ä»¥åŠä¿®æ­£ä¸€äº›é”™è¯¯ï¼Œå› æ­¤è½¬è½½è¯·ä¿ç•™åŸå‡ºå¤„ï¼Œæ–¹ä¾¿æº¯æºï¼Œé¿å…é™ˆæ—§é”™è¯¯çŸ¥è¯†çš„è¯¯å¯¼ï¼ŒåŒæ—¶æœ‰æ›´å¥½çš„é˜…è¯»ä½“éªŒã€‚</span>
  </li>
</ul>

      </div>
    


    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/28/KVO/" rel="next" title="æˆ‘ç†è§£çš„KVO">
                <i class="fa fa-chevron-left"></i> æˆ‘ç†è§£çš„KVO
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/19/FBKVOController/" rel="prev" title="è¯»ä¸€è¯»KVOController">
                è¯»ä¸€è¯»KVOController <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
    


  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">

            <canvas id='sidebar-author'></canvas>
            <a href="/"  class="site-author-image" rel="start" style="border: none;" title="è®¸æ¡‚æ–Œ">
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="è®¸æ¡‚æ–Œ" />
            </a>
            <p class="site-author-name" itemprop="name">è®¸æ¡‚æ–Œ</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <!-- <a href="/archives/ || archive"> -->
              <a href="/archives">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories"> 
              <!--  -->
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              <!--  -->
              </a>
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        <div id="sidebarClock" class="customFlipClock" style="height: 46px;width: 100%; ">TwentyFourHourClock</div>


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#AFNetworkingçš„ç»“æ„"><span class="nav-number">1.</span> <span class="nav-text">AFNetworkingçš„ç»“æ„</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Serializationæ¨¡å—"><span class="nav-number">2.</span> <span class="nav-text">Serializationæ¨¡å—</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AFURLRequestSerialization-h"><span class="nav-number">2.1.</span> <span class="nav-text">AFURLRequestSerialization.h</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å…¬å¼€å±æ€§"><span class="nav-number">2.1.1.</span> <span class="nav-text">å…¬å¼€å±æ€§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API"><span class="nav-number">2.1.2.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AFMultipartFormDataåè®®"><span class="nav-number">2.1.3.</span> <span class="nav-text">AFMultipartFormDataåè®®</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AFURLRequestSerialization-m"><span class="nav-number">2.2.</span> <span class="nav-text">AFURLRequestSerialization.m</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å·¥å…·æ–¹æ³•"><span class="nav-number">2.2.1.</span> <span class="nav-text">å·¥å…·æ–¹æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AFHTTPRequestSerializeråºåˆ—åŒ–æµç¨‹"><span class="nav-number">2.2.2.</span> <span class="nav-text">AFHTTPRequestSerializeråºåˆ—åŒ–æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸Šä¼ æ–‡ä»¶"><span class="nav-number">2.2.3.</span> <span class="nav-text">ä¸Šä¼ æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AFHTTPRequestSerializerå­ç±»"><span class="nav-number">2.2.4.</span> <span class="nav-text">AFHTTPRequestSerializerå­ç±»</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AFURLResponseSerialization-h"><span class="nav-number">2.3.</span> <span class="nav-text">AFURLResponseSerialization.h</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AFURLResponseSerialization-m"><span class="nav-number">2.4.</span> <span class="nav-text">AFURLResponseSerialization.m</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Securityæ¨¡å—"><span class="nav-number">3.</span> <span class="nav-text">Securityæ¨¡å—</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reachabilityæ¨¡å—"><span class="nav-number">4.</span> <span class="nav-text">Reachabilityæ¨¡å—</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NSURLSessionæ¨¡å—"><span class="nav-number">5.</span> <span class="nav-text">NSURLSessionæ¨¡å—</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AFURLSessionManager"><span class="nav-number">5.1.</span> <span class="nav-text">AFURLSessionManager</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AFHTTPSessionManager"><span class="nav-number">5.2.</span> <span class="nav-text">AFHTTPSessionManager</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">è®¸æ¡‚æ–Œ</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/function.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  <script type="text/javascript" src="/lib/zclip/clipboard.min.js"></script>	
<script type="text/javascript" src="/lib/flipclock/flipclock.min.js"></script>	
<script type="text/javascript" src="/js/src/customeFlipClock.js"></script>	
<script type="text/javascript" src="/js/src/codescrollbar.js"></script>	
<script type="text/javascript" src="/lib/tag3dCloud/tag3dCloud.min.js"> </script>
<script type="text/javascript" src="/lib/wobblewindow/wobblewindow.js"> </script>
<script type="text/javascript" src="/js/src/custom.js"></script>	
<script >
	$(document).ready(
	function()
		{			
			
		}
	);	
</script>
  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname, 
            owner: 'xxxxxxgb',
            repo: 'https://github.com/xxxxxxgb/blog-comments.git',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '1e8c9abc6901b421808690eb1e3572708f8fd52c',
            
                client_id: 'ba95ef24632c5a4a4b28'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
